<<<<<<< HEAD
diff --git a/ayanavita-fontend/src/api/adminCourses.api.ts b/ayanavita-fontend/src/api/adminCourses.api.ts
index 8dadf09184750b19b99d2469dc1275352b126441..0f8781a0286cc222b0d9817b7445ae9bb5bbf619 100644
--- a/ayanavita-fontend/src/api/adminCourses.api.ts
+++ b/ayanavita-fontend/src/api/adminCourses.api.ts
@@ -1,39 +1,145 @@
 import { del, get, patch, post } from './http'

 export type CourseTopicTranslations = Record<string, { name?: string; description?: string | null }>

 export type CourseTopic = {
   id: number
   name: string
   description?: string | null
   translations?: CourseTopicTranslations
   _count?: { courses: number }
 }

+export type LocalizedText = { vi?: string; 'en-US'?: string; de?: string }
+
+export type LessonVideoPayload = {
+  title: string
+  description?: string
+  titleI18n?: LocalizedText
+  descriptionI18n?: LocalizedText
+  sourceUrl?: string
+  durationSec?: number
+  order?: number
+  published?: boolean
+}
+
+export type LessonModulePayload = {
+  title: string
+  description?: string
+  titleI18n?: LocalizedText
+  descriptionI18n?: LocalizedText
+  order?: number
+  published?: boolean
+  videos?: LessonVideoPayload[]
+}
+
+export type LessonPayload = {
+  title: string
+  slug: string
+  description?: string
+  titleI18n?: LocalizedText
+  descriptionI18n?: LocalizedText
+  content?: string
+  videoUrl?: string
+  modules?: LessonModulePayload[]
+  order?: number
+  published?: boolean
+}
+
+export type LessonVideoAdmin = LessonVideoPayload & { id: number; hlsPlaylistKey?: string }
+export type LessonModuleAdmin = LessonModulePayload & { id: number; videos: LessonVideoAdmin[] }
+
+export type LessonAdmin = {
+  id: number
+  courseId: number
+  title: string
+  slug: string
+  description?: string
+  titleI18n?: LocalizedText
+  descriptionI18n?: LocalizedText
+  content?: string
+  order?: number
+  published: boolean
+  createdAt?: string
+  updatedAt?: string
+}
+
+export type LessonDetailAdmin = LessonAdmin & { modules: LessonModuleAdmin[] }
+
 export type CourseAdmin = {
   id: number
   topicId?: number | null
   title: string
   slug: string
+  description?: string | null
+  thumbnail?: string | null
   published: boolean
   price: number
   topic?: { id: number; name: string } | null
+  titleI18n?: LocalizedText
+  descriptionI18n?: LocalizedText
+  shortDescriptionI18n?: LocalizedText
+  objectives?: string[]
+  targetAudience?: string[]
+  benefits?: string[]
+  ratingAvg?: number
+  ratingCount?: number
+  enrollmentCount?: number
+  _count?: { lessons?: number }
 }

 export type TopicPayload = {
   name?: string
   description?: string
   translations?: {
     vi?: { name?: string; description?: string }
     'en-US'?: { name?: string; description?: string }
     de?: { name?: string; description?: string }
   }
 }

+export type CoursePayload = {
+  topicId?: number
+  title: string
+  slug: string
+  description?: string
+  thumbnail?: string
+  price?: number
+  published?: boolean
+  titleI18n?: LocalizedText
+  descriptionI18n?: LocalizedText
+  shortDescriptionI18n?: LocalizedText
+  objectives?: string[]
+  targetAudience?: string[]
+  benefits?: string[]
+  ratingAvg?: number
+  ratingCount?: number
+  enrollmentCount?: number
+}
+
 export const adminCoursesApi = {
   listTopics: () => get<CourseTopic[]>('/admin/course-topics', { auth: true }),
   createTopic: (body: TopicPayload) => post<CourseTopic>('/admin/course-topics', body, { auth: true }),
   updateTopic: (id: number, body: TopicPayload) => patch<CourseTopic>(`/admin/course-topics/${id}`, body, { auth: true }),
   deleteTopic: (id: number) => del<{ id: number }>(`/admin/course-topics/${id}`, { auth: true }),
   listCourses: () => get<CourseAdmin[]>('/courses', { auth: true }),
+  createCourse: (body: CoursePayload) => post<CourseAdmin>('/courses', body, { auth: true }),
+  updateCourse: (id: number, body: Partial<CoursePayload>) => patch<CourseAdmin>(`/courses/${id}`, body, { auth: true }),
+  deleteCourse: (id: number) => del<{ id: number }>(`/courses/${id}`, { auth: true }),
+
+  listCourseLessons: (courseId: number) => get<LessonAdmin[]>(`/courses/${courseId}/lessons-outline`, { auth: true }),
+  getLessonDetail: (lessonId: number) => get<LessonDetailAdmin>(`/lessons/${lessonId}`, { auth: true }),
+  createLesson: (courseId: number, body: LessonPayload) => post<LessonAdmin>(`/courses/${courseId}/lessons`, body, { auth: true }),
+  updateLesson: (lessonId: number, body: Partial<LessonPayload>) => patch<LessonAdmin>(`/lessons/${lessonId}`, body, { auth: true }),
+  deleteLesson: (lessonId: number) => del<{ id: number }>(`/lessons/${lessonId}`, { auth: true }),
+
+  uploadModuleVideo: (lessonId: number, moduleId: string | number, file: File) => {
+    const body = new FormData()
+    body.append('file', file)
+    return post<{ moduleId: string; lessonId: number; hlsPlaylistKey: string; segmentCount: number; storage: string }>(
+      `/lessons/${lessonId}/modules/${moduleId}/videos/upload`,
+      body,
+      { auth: true },
+    )
+  },
 }
diff --git a/ayanavita-fontend/src/pages/admin/AdminCoursesPage.css b/ayanavita-fontend/src/pages/admin/AdminCoursesPage.css
index b37662f35f781cd7c147e49f3f04da16250cc1a5..00399b312ab2d923e2157ac702e4943fc43949f9 100644
--- a/ayanavita-fontend/src/pages/admin/AdminCoursesPage.css
+++ b/ayanavita-fontend/src/pages/admin/AdminCoursesPage.css
@@ -245,25 +245,202 @@
   color: #93c5fd;
 }

 .admin-courses-theme-dark .admin-table td {
   border-top-color: #1e293b;
 }

 .admin-courses-theme-dark .admin-table tbody tr:hover {
   background: rgba(30, 41, 59, 0.5);
 }

 .admin-courses-theme-dark .admin-tab {
   background: #0f172a;
   border-color: #334155;
   color: #cbd5e1;
 }

 .admin-courses-theme-dark .admin-tab.active {
   background: linear-gradient(135deg, #0ea5e9, #14b8a6);
   color: #052f3a;
 }

 .admin-courses-theme-dark .admin-topic-form-watermark span {
   color: rgba(74, 222, 128, 0.18);
 }
+
+.admin-check {
+  display: inline-flex;
+  align-items: center;
+  gap: 8px;
+  font-weight: 700;
+}
+
+.admin-check input {
+  width: 16px;
+  height: 16px;
+}
+
+.admin-course-management-card {
+  width: 100%;
+}
+
+.admin-table-wrap-full {
+  width: 100%;
+  overflow-x: auto;
+}
+
+.admin-table-courses-full {
+  min-width: 1680px;
+}
+
+.status-pill {
+  display: inline-flex;
+  padding: 4px 10px;
+  border-radius: 999px;
+  font-size: 12px;
+  font-weight: 700;
+}
+
+.status-pill.is-published {
+  background: rgba(34, 197, 94, .16);
+  color: #15803d;
+}
+
+.status-pill.is-draft {
+  background: rgba(234, 88, 12, .14);
+  color: #9a3412;
+}
+
+.admin-modal-backdrop {
+  position: fixed;
+  inset: 0;
+  background: rgba(2, 6, 23, 0.6);
+  backdrop-filter: blur(2px);
+  display: flex;
+  align-items: center;
+  justify-content: center;
+  z-index: 40;
+  padding: 18px;
+}
+
+.admin-modal {
+  width: min(1400px, 96vw);
+  max-height: 94vh;
+  overflow: auto;
+  background: var(--ad-card);
+  border: 1px solid var(--ad-border);
+  border-radius: 16px;
+  padding: 18px;
+}
+
+.admin-modal-header {
+  display: flex;
+  align-items: center;
+  justify-content: space-between;
+  margin-bottom: 12px;
+}
+
+.admin-modal-header h4 {
+  margin: 0;
+  font-size: 20px;
+}
+
+.admin-courses-theme-dark .admin-modal {
+  background: rgba(15, 23, 42, 0.95);
+  border-color: rgba(51, 65, 85, 0.8);
+}
+
+.admin-courses-theme-dark .status-pill.is-published {
+  background: rgba(34, 197, 94, .22);
+  color: #86efac;
+}
+
+.admin-courses-theme-dark .status-pill.is-draft {
+  background: rgba(251, 146, 60, .2);
+  color: #fdba74;
+}
+
+.admin-form-grid-2col {
+  grid-template-columns: repeat(2, minmax(0, 1fr));
+  gap: 10px;
+}
+
+.admin-field-full {
+  grid-column: 1 / -1;
+}
+
+.admin-modal-compact {
+  padding: 14px;
+}
+
+.admin-curriculum-grid {
+  display: grid;
+  grid-template-columns: 1.4fr 1fr;
+  gap: 12px;
+}
+
+@media (max-width: 1200px) {
+  .admin-form-grid-2col {
+    grid-template-columns: 1fr;
+  }
+  .admin-curriculum-grid {
+    grid-template-columns: 1fr;
+  }
+}
+
+.admin-input-compact {
+  max-width: 100%;
+  min-width: 0;
+}
+
+.admin-table-courses-full th,
+.admin-table-courses-full td {
+  white-space: nowrap;
+}
+
+.admin-table-courses-full th:nth-child(1),
+.admin-table-courses-full td:nth-child(1) { width: 56px; }
+.admin-table-courses-full th:nth-child(2),
+.admin-table-courses-full td:nth-child(2) { width: 220px; }
+.admin-table-courses-full th:nth-child(3),
+.admin-table-courses-full td:nth-child(3) { width: 180px; }
+.admin-table-courses-full th:nth-child(4),
+.admin-table-courses-full td:nth-child(4) { width: 150px; }
+.admin-table-courses-full th:nth-child(5),
+.admin-table-courses-full td:nth-child(5) { width: 110px; }
+.admin-table-courses-full th:nth-child(6),
+.admin-table-courses-full td:nth-child(6) { width: 120px; }
+.admin-table-courses-full th:nth-child(7),
+.admin-table-courses-full td:nth-child(7) { width: 100px; }
+.admin-table-courses-full th:nth-child(8),
+.admin-table-courses-full td:nth-child(8) { width: 90px; }
+.admin-table-courses-full th:nth-child(9),
+.admin-table-courses-full td:nth-child(9) { width: 110px; }
+.admin-table-courses-full th:nth-child(10),
+.admin-table-courses-full td:nth-child(10) { width: 120px; }
+
+.no-scroll-table {
+  width: 100%;
+  table-layout: fixed;
+}
+
+.no-scroll-table th,
+.no-scroll-table td {
+  white-space: normal !important;
+  word-break: break-word;
+}
+
+.no-scroll-table th:nth-child(1), .no-scroll-table td:nth-child(1) { width: 4%; }
+.no-scroll-table th:nth-child(2), .no-scroll-table td:nth-child(2) { width: 18%; }
+.no-scroll-table th:nth-child(3), .no-scroll-table td:nth-child(3) { width: 14%; }
+.no-scroll-table th:nth-child(4), .no-scroll-table td:nth-child(4) { width: 12%; }
+.no-scroll-table th:nth-child(5), .no-scroll-table td:nth-child(5) { width: 9%; }
+.no-scroll-table th:nth-child(6), .no-scroll-table td:nth-child(6) { width: 10%; }
+.no-scroll-table th:nth-child(7), .no-scroll-table td:nth-child(7) { width: 8%; }
+.no-scroll-table th:nth-child(8), .no-scroll-table td:nth-child(8) { width: 7%; }
+.no-scroll-table th:nth-child(9), .no-scroll-table td:nth-child(9) { width: 8%; }
+.no-scroll-table th:nth-child(10), .no-scroll-table td:nth-child(10) { width: 10%; }
+
+.admin-modal {
+  width: min(1200px, 95vw);
+}
diff --git a/ayanavita-fontend/src/pages/admin/AdminCoursesPage.tsx b/ayanavita-fontend/src/pages/admin/AdminCoursesPage.tsx
index 96d1e94d44b46a15859f1e4f9d073fa9305ec02a..d3a2f098da28adca1c21aa6e6a7ed316add00dee 100644
--- a/ayanavita-fontend/src/pages/admin/AdminCoursesPage.tsx
+++ b/ayanavita-fontend/src/pages/admin/AdminCoursesPage.tsx
@@ -250,50 +250,87 @@ export default function AdminCoursesPage() {
         await adminCoursesApi.createTopic(payload)
         AlertJs.success(t.createSuccess)
       }
       resetForm()
       await loadAll()
     } catch (e: any) {
       AlertJs.error(e?.message || t.saveFailed)
     }
   }

   const deleteTopic = async (topic: CourseTopic) => {
     try {
       await adminCoursesApi.deleteTopic(topic.id)
       AlertJs.success(t.deleteSuccess)
       await loadAll()
     } catch (e: any) {
       AlertJs.error(e?.message || t.deleteFailed)
     }
   }

   const startEditTopic = (topic: CourseTopic) => {
     setEditingId(topic.id)
     setTopicForm(toTopicForm(topic))
   }

+
+  const createCourse = async (payload: any) => {
+    try {
+      await adminCoursesApi.createCourse(payload)
+      AlertJs.success('Đã tạo khoá học')
+      await loadAll()
+    } catch (e: any) {
+      AlertJs.error(e?.message || 'Tạo khoá học thất bại')
+      throw e
+    }
+  }
+
+  const updateCourse = async (id: number, payload: any) => {
+    try {
+      await adminCoursesApi.updateCourse(id, payload)
+      AlertJs.success('Đã cập nhật khoá học')
+      await loadAll()
+    } catch (e: any) {
+      AlertJs.error(e?.message || 'Cập nhật khoá học thất bại')
+      throw e
+    }
+  }
+
+  const deleteCourse = async (course: CourseAdmin) => {
+    const ok = window.confirm(`Xoá khoá học "${course.title}"?`)
+    if (!ok) return
+
+    try {
+      await adminCoursesApi.deleteCourse(course.id)
+      AlertJs.success('Đã xoá khoá học')
+      await loadAll()
+    } catch (e: any) {
+      AlertJs.error(e?.message || 'Xoá khoá học thất bại')
+      throw e
+    }
+  }
+
   return (
     <main className={`admin-page admin-courses-theme ${theme === 'dark' ? 'admin-courses-theme-dark' : ''}`}>
       <section className='admin-header'>
         <div>
           <p className='admin-header-kicker'>{t.kicker}</p>
           <h1>{t.title}</h1>
           <p>{t.subtitle}</p>
         </div>

         <div className='admin-courses-theme-switch' role='group' aria-label='Display settings'>
           <span className='admin-courses-theme-switch-label'>{t.darkMode}</span>
           <button
             type='button'
             className={`admin-courses-theme-toggle ${theme === 'dark' ? 'active' : ''}`}
             onClick={() => setTheme((prev) => (prev === 'dark' ? 'light' : 'dark'))}
             aria-label={theme === 'dark' ? 'Switch to light mode' : 'Switch to dark mode'}
             aria-pressed={theme === 'dark'}
           >
             <span className='admin-courses-theme-toggle-thumb' />
           </button>

           <div className='admin-lang-switch' role='group' aria-label={t.displayMode}>
             {(['en-US', 'de', 'vi'] as AdminLang[]).map((code) => {
               const item = languageMeta[code]
               const active = lang === code
@@ -345,29 +382,38 @@ export default function AdminCoursesPage() {
         <button className={`admin-tab ${tab === 'courses' ? 'active' : ''}`} onClick={() => setTab('courses')}>
           <i className='fa-solid fa-graduation-cap' /> {t.coursesTab}
         </button>
       </section>

       {loading && <p className='admin-helper'>{t.loading}</p>}

       {!loading && tab === 'topics' && (
         <TopicsTab
           topics={topics}
           coursesByTopic={coursesByTopic}
           topicForm={topicForm}
           editingId={editingId}
           displayLang={lang}
           text={{ ...t, courseCount: t.courseCountCol }}
           setTopicField={setTopicField}
           onSave={saveTopic}
           onReset={resetForm}
           onEdit={startEditTopic}
           onDelete={(topic) => {
             void deleteTopic(topic)
           }}
         />
       )}

-      {!loading && tab === 'courses' && <CoursesTab courses={courses} />}
+      {!loading && tab === 'courses' && (
+        <CoursesTab
+          courses={courses}
+          topics={topics}
+          text={t}
+          onCreateCourse={createCourse}
+          onUpdateCourse={updateCourse}
+          onDeleteCourse={deleteCourse}
+        />
+      )}
     </main>
   )
 }
diff --git a/ayanavita-fontend/src/pages/admin/courseTabs/CoursesTab.tsx b/ayanavita-fontend/src/pages/admin/courseTabs/CoursesTab.tsx
index 12bf9d2186a2504caa5b8938cb1c1e385e937946..bef4e885bace9e9e8e98bf3a0977054cb1e3116e 100644
--- a/ayanavita-fontend/src/pages/admin/courseTabs/CoursesTab.tsx
+++ b/ayanavita-fontend/src/pages/admin/courseTabs/CoursesTab.tsx
@@ -1,39 +1,608 @@
-import type { CourseAdmin } from '../../../api/adminCourses.api'
+import { useMemo, useState } from 'react'
+import {
+  adminCoursesApi,
+  type CourseAdmin,
+  type CoursePayload,
+  type CourseTopic,
+  type LessonAdmin,
+  type LessonDetailAdmin,
+  type LessonModulePayload,
+  type LessonPayload,
+  type LessonVideoPayload,
+  type LocalizedText,
+} from '../../../api/adminCourses.api'
+import { AlertJs } from '../../../utils/alertJs'
+import { autoTranslateFromVietnamese } from '../tabs/i18nForm'

 type Props = {
   courses: CourseAdmin[]
+  topics: CourseTopic[]
+  text: Record<string, string>
+  onCreateCourse: (payload: CoursePayload) => Promise<void>
+  onUpdateCourse: (id: number, payload: Partial<CoursePayload>) => Promise<void>
+  onDeleteCourse: (course: CourseAdmin) => Promise<void>
 }

-export function CoursesTab({ courses }: Props) {
+type Lang = 'vi' | 'en-US' | 'de'
+
+type CourseForm = {
+  topicId?: number
+  title: string
+  slug: string
+  description: string
+  thumbnail: string
+  price: number
+  published: boolean
+  titleI18n: LocalizedText
+  descriptionI18n: LocalizedText
+  objectivesText: string
+  audienceText: string
+  benefitsText: string
+  ratingAvg: number
+  ratingCount: number
+  enrollmentCount: number
+}
+
+type VideoDraft = LessonVideoPayload & { id?: number }
+type ModuleDraft = LessonModulePayload & { id?: number; videos: VideoDraft[] }
+type LessonDraft = {
+  id?: number
+  title: string
+  slug: string
+  description?: string
+  titleI18n: LocalizedText
+  descriptionI18n: LocalizedText
+  content?: string
+  order: number
+  published: boolean
+  modules: ModuleDraft[]
+}
+
+const emptyCourseForm: CourseForm = {
+  title: '', slug: '', description: '', thumbnail: '', price: 0, published: false,
+  titleI18n: { vi: '', 'en-US': '', de: '' },
+  descriptionI18n: { vi: '', 'en-US': '', de: '' },
+  objectivesText: '', audienceText: '', benefitsText: '',
+  ratingAvg: 0, ratingCount: 0, enrollmentCount: 0,
+}
+
+const emptyLessonDraft: LessonDraft = {
+  title: '', slug: '', description: '', titleI18n: { vi: '', 'en-US': '', de: '' },
+  descriptionI18n: { vi: '', 'en-US': '', de: '' },
+  content: '', order: 1, published: true,
+  modules: [{ title: '', description: '', titleI18n: { vi: '', 'en-US': '', de: '' }, descriptionI18n: { vi: '', 'en-US': '', de: '' }, order: 1, published: true, videos: [{ title: '', description: '', titleI18n: { vi: '', 'en-US': '', de: '' }, descriptionI18n: { vi: '', 'en-US': '', de: '' }, sourceUrl: '', durationSec: 0, order: 1, published: true }] }],
+}
+
+const linesToArray = (v: string) => v.split('\n').map((x) => x.trim()).filter(Boolean)
+
+function toCourseForm(course: CourseAdmin): CourseForm {
+  return {
+    topicId: course.topicId || undefined,
+    title: course.title || '',
+    slug: course.slug || '',
+    description: course.description || '',
+    thumbnail: course.thumbnail || '',
+    price: Number(course.price) || 0,
+    published: Boolean(course.published),
+    titleI18n: {
+      vi: course.titleI18n?.vi || course.title || '',
+      'en-US': course.titleI18n?.['en-US'] || '',
+      de: course.titleI18n?.de || '',
+    },
+    descriptionI18n: {
+      vi: course.descriptionI18n?.vi || course.description || '',
+      'en-US': course.descriptionI18n?.['en-US'] || '',
+      de: course.descriptionI18n?.de || '',
+    },
+    objectivesText: (course.objectives || []).join('\n'),
+    audienceText: (course.targetAudience || []).join('\n'),
+    benefitsText: (course.benefits || []).join('\n'),
+    ratingAvg: Number(course.ratingAvg) || 0,
+    ratingCount: Number(course.ratingCount) || 0,
+    enrollmentCount: Number(course.enrollmentCount) || 0,
+  }
+}
+
+function toLessonDraft(detail: LessonDetailAdmin): LessonDraft {
+  return {
+    id: detail.id,
+    title: detail.title,
+    slug: detail.slug,
+    description: detail.description,
+    titleI18n: detail.titleI18n || { vi: '', 'en-US': '', de: '' },
+    descriptionI18n: detail.descriptionI18n || { vi: '', 'en-US': '', de: '' },
+    content: detail.content,
+    order: detail.order || 1,
+    published: detail.published,
+    modules: (detail.modules || []).map((m, mi) => ({
+      id: m.id,
+      title: m.title,
+      description: m.description,
+      titleI18n: m.titleI18n || { vi: '', 'en-US': '', de: '' },
+      descriptionI18n: m.descriptionI18n || { vi: '', 'en-US': '', de: '' },
+      order: m.order ?? mi + 1,
+      published: m.published ?? true,
+      videos: (m.videos || []).map((v, vi) => ({
+        id: v.id,
+        title: v.title,
+        description: v.description,
+        titleI18n: v.titleI18n || { vi: '', 'en-US': '', de: '' },
+        descriptionI18n: v.descriptionI18n || { vi: '', 'en-US': '', de: '' },
+        sourceUrl: v.sourceUrl,
+        durationSec: v.durationSec,
+        order: v.order ?? vi + 1,
+        published: v.published ?? true,
+      })),
+    })),
+  }
+}
+
+export function CoursesTab({ courses, topics, text, onCreateCourse, onUpdateCourse, onDeleteCourse }: Props) {
+  const [langMode, setLangMode] = useState<Lang>('vi')
+  const [form, setForm] = useState<CourseForm>(emptyCourseForm)
+  const [editing, setEditing] = useState<CourseAdmin | null>(null)
+  const [modalOpen, setModalOpen] = useState(false)
+  const [saving, setSaving] = useState(false)
+
+  const [lessons, setLessons] = useState<LessonAdmin[]>([])
+  const [lessonDraft, setLessonDraft] = useState<LessonDraft>(emptyLessonDraft)
+  const [editingLessonId, setEditingLessonId] = useState<number | null>(null)
+  const [uploadingFor, setUploadingFor] = useState<string>('')
+
+  const sortedCourses = useMemo(() => [...courses].sort((a, b) => b.id - a.id), [courses])
+
+  const loadLessons = async (courseId: number) => {
+    try {
+      setLessons(await adminCoursesApi.listCourseLessons(courseId))
+    } catch (e: any) {
+      AlertJs.error(e?.message || 'Không tải được bài học')
+      setLessons([])
+    }
+  }
+
+  const openCreate = () => {
+    setEditing(null)
+    setForm(emptyCourseForm)
+    setLessons([])
+    setLessonDraft(emptyLessonDraft)
+    setEditingLessonId(null)
+    setLangMode('vi')
+    setModalOpen(true)
+  }
+
+  const openEdit = async (course: CourseAdmin) => {
+    setEditing(course)
+    setForm(toCourseForm(course))
+    setLessonDraft(emptyLessonDraft)
+    setEditingLessonId(null)
+    setLangMode('vi')
+    setModalOpen(true)
+    await loadLessons(course.id)
+  }
+
+  const closeModal = () => {
+    if (saving) return
+    setModalOpen(false)
+  }
+
+  const autoTranslateCourse = (field: 'titleI18n' | 'descriptionI18n', value: string) => {
+    setForm((prev) => ({ ...prev, [field]: { ...prev[field], vi: value } }))
+    void Promise.all([autoTranslateFromVietnamese(value, 'en-US'), autoTranslateFromVietnamese(value, 'de')]).then(([en, de]) => {
+      setForm((prev) => ({ ...prev, [field]: { ...prev[field], 'en-US': en, de } }))
+    })
+  }
+
+  const submitCourse = async () => {
+    if (!form.title.trim() || !form.slug.trim()) {
+      AlertJs.error('Tiêu đề và slug là bắt buộc')
+      return
+    }
+
+    const payload: CoursePayload = {
+      topicId: form.topicId,
+      title: form.title.trim(),
+      slug: form.slug.trim(),
+      description: form.description.trim() || undefined,
+      thumbnail: form.thumbnail.trim() || undefined,
+      price: Number(form.price || 0),
+      published: form.published,
+      titleI18n: form.titleI18n,
+      descriptionI18n: form.descriptionI18n,
+      objectives: linesToArray(form.objectivesText),
+      targetAudience: linesToArray(form.audienceText),
+      benefits: linesToArray(form.benefitsText),
+      ratingAvg: Number(form.ratingAvg || 0),
+      ratingCount: Number(form.ratingCount || 0),
+      enrollmentCount: Number(form.enrollmentCount || 0),
+    }
+
+    setSaving(true)
+    try {
+      if (editing) await onUpdateCourse(editing.id, payload)
+      else await onCreateCourse(payload)
+      closeModal()
+    } finally {
+      setSaving(false)
+    }
+  }
+
+  const addModule = () => {
+    setLessonDraft((prev) => ({
+      ...prev,
+      modules: [...prev.modules, { title: '', description: '', titleI18n: { vi: '', 'en-US': '', de: '' }, descriptionI18n: { vi: '', 'en-US': '', de: '' }, order: prev.modules.length + 1, published: true, videos: [] }],
+    }))
+  }
+
+  const removeModule = (idx: number) => {
+    setLessonDraft((prev) => ({ ...prev, modules: prev.modules.filter((_, i) => i !== idx) }))
+  }
+
+  const updateModule = (idx: number, patch: Partial<ModuleDraft>) => {
+    setLessonDraft((prev) => ({
+      ...prev,
+      modules: prev.modules.map((m, i) => (i === idx ? { ...m, ...patch } : m)),
+    }))
+  }
+
+  const addVideo = (moduleIdx: number) => {
+    setLessonDraft((prev) => ({
+      ...prev,
+      modules: prev.modules.map((m, i) => i === moduleIdx
+        ? { ...m, videos: [...m.videos, { title: '', description: '', titleI18n: { vi: '', 'en-US': '', de: '' }, descriptionI18n: { vi: '', 'en-US': '', de: '' }, sourceUrl: '', durationSec: 0, order: m.videos.length + 1, published: true }] }
+        : m),
+    }))
+  }
+
+  const removeVideo = (moduleIdx: number, videoIdx: number) => {
+    setLessonDraft((prev) => ({
+      ...prev,
+      modules: prev.modules.map((m, i) => i === moduleIdx ? { ...m, videos: m.videos.filter((_, vi) => vi !== videoIdx) } : m),
+    }))
+  }
+
+  const updateVideo = (moduleIdx: number, videoIdx: number, patch: Partial<VideoDraft>) => {
+    setLessonDraft((prev) => ({
+      ...prev,
+      modules: prev.modules.map((m, i) => i === moduleIdx
+        ? { ...m, videos: m.videos.map((v, vi) => (vi === videoIdx ? { ...v, ...patch } : v)) }
+        : m),
+    }))
+  }
+
+  const autoTranslateLesson = (kind: 'lessonTitle' | 'lessonDesc' | 'moduleTitle' | 'moduleDesc' | 'videoTitle' | 'videoDesc', value: string, moduleIdx?: number, videoIdx?: number) => {
+    const apply = (en: string, de: string) => {
+      setLessonDraft((prev) => {
+        if (kind === 'lessonTitle') return { ...prev, titleI18n: { ...prev.titleI18n, vi: value, 'en-US': en, de } }
+        if (kind === 'lessonDesc') return { ...prev, descriptionI18n: { ...prev.descriptionI18n, vi: value, 'en-US': en, de } }
+        if (moduleIdx === undefined) return prev
+        if (kind === 'moduleTitle') {
+          const modules = prev.modules.map((m, i) => i === moduleIdx ? { ...m, titleI18n: { ...m.titleI18n, vi: value, 'en-US': en, de } } : m)
+          return { ...prev, modules }
+        }
+        if (kind === 'moduleDesc') {
+          const modules = prev.modules.map((m, i) => i === moduleIdx ? { ...m, descriptionI18n: { ...m.descriptionI18n, vi: value, 'en-US': en, de } } : m)
+          return { ...prev, modules }
+        }
+        if (videoIdx === undefined) return prev
+        const modules = prev.modules.map((m, i) => i !== moduleIdx ? m : {
+          ...m,
+          videos: m.videos.map((v, vi) => {
+            if (vi !== videoIdx) return v
+            if (kind === 'videoTitle') return { ...v, titleI18n: { ...v.titleI18n, vi: value, 'en-US': en, de } }
+            return { ...v, descriptionI18n: { ...v.descriptionI18n, vi: value, 'en-US': en, de } }
+          }),
+        })
+        return { ...prev, modules }
+      })
+    }
+
+    void Promise.all([autoTranslateFromVietnamese(value, 'en-US'), autoTranslateFromVietnamese(value, 'de')]).then(([en, de]) => apply(en, de))
+  }
+
+  const saveLesson = async () => {
+    if (!editing) return
+    if (!lessonDraft.title.trim() || !lessonDraft.slug.trim()) {
+      AlertJs.error('Vui lòng nhập tiêu đề + slug bài học')
+      return
+    }
+
+    const payload: LessonPayload = {
+      title: lessonDraft.title.trim(),
+      slug: lessonDraft.slug.trim(),
+      description: lessonDraft.description,
+      titleI18n: lessonDraft.titleI18n,
+      descriptionI18n: lessonDraft.descriptionI18n,
+      content: lessonDraft.content,
+      order: lessonDraft.order,
+      published: lessonDraft.published,
+      modules: lessonDraft.modules.map((m) => ({
+        title: m.title,
+        description: m.description,
+        titleI18n: m.titleI18n,
+        descriptionI18n: m.descriptionI18n,
+        order: m.order,
+        published: m.published,
+        videos: m.videos.map((v) => ({
+          title: v.title,
+          description: v.description,
+          titleI18n: v.titleI18n,
+          descriptionI18n: v.descriptionI18n,
+          sourceUrl: v.sourceUrl,
+          durationSec: Number(v.durationSec || 0),
+          order: v.order,
+          published: v.published,
+        })),
+      })),
+    }
+
+    try {
+      if (editingLessonId) {
+        await adminCoursesApi.updateLesson(editingLessonId, payload)
+        AlertJs.success('Đã cập nhật bài học')
+      } else {
+        await adminCoursesApi.createLesson(editing.id, payload)
+        AlertJs.success('Đã tạo bài học')
+      }
+      await loadLessons(editing.id)
+      setLessonDraft(emptyLessonDraft)
+      setEditingLessonId(null)
+    } catch (e: any) {
+      AlertJs.error(e?.message || 'Lưu bài học thất bại')
+    }
+  }
+
+  const editLesson = async (lessonId: number) => {
+    try {
+      const detail = await adminCoursesApi.getLessonDetail(lessonId)
+      setLessonDraft(toLessonDraft(detail))
+      setEditingLessonId(lessonId)
+    } catch (e: any) {
+      AlertJs.error(e?.message || 'Không tải được chi tiết bài học')
+    }
+  }
+
+  const deleteLesson = async (lessonId: number) => {
+    if (!editing) return
+    try {
+      await adminCoursesApi.deleteLesson(lessonId)
+      AlertJs.success('Đã xoá bài học')
+      await loadLessons(editing.id)
+      if (editingLessonId === lessonId) {
+        setLessonDraft(emptyLessonDraft)
+        setEditingLessonId(null)
+      }
+    } catch (e: any) {
+      AlertJs.error(e?.message || 'Xoá bài học thất bại')
+    }
+  }
+
+  const uploadVideo = async (lessonId: number, moduleId?: number, file?: File | null) => {
+    if (!moduleId || !file) {
+      AlertJs.error('Hãy lưu bài học trước để có module ID rồi mới upload video')
+      return
+    }
+    const key = `${lessonId}-${moduleId}`
+    setUploadingFor(key)
+    try {
+      await adminCoursesApi.uploadModuleVideo(lessonId, moduleId, file)
+      AlertJs.success('Đã upload video, backend đang xử lý HLS + lưu private bucket')
+    } catch (e: any) {
+      AlertJs.error(e?.message || 'Upload video thất bại')
+    } finally {
+      setUploadingFor('')
+    }
+  }
+
   return (
-    <section className='admin-card admin-card-glow'>
-      <h3 className='admin-card-title'><i className='fa-solid fa-book' /> Khoá học hiện có ({courses.length})</h3>
+    <section className='admin-card admin-card-glow admin-course-management-card'>
+      <div className='admin-row' style={{ justifyContent: 'space-between', alignItems: 'center' }}>
+        <h3 className='admin-card-title'><i className='fa-solid fa-book' /> {text.coursesTab} ({courses.length})</h3>
+        <button className='admin-btn admin-btn-save' type='button' onClick={openCreate}><i className='fa-solid fa-circle-plus' /> Tạo khoá học</button>
+      </div>
+
       <div className='admin-table-wrap'>
-        <table className='admin-table'>
+        <table className='admin-table admin-table-courses-full no-scroll-table'>
           <thead>
             <tr>
-              <th>ID</th>
-              <th>Tiêu đề</th>
-              <th>Slug</th>
-              <th>Chủ đề</th>
-              <th>Giá</th>
-              <th>Trạng thái</th>
+              <th>ID</th><th>Tiêu đề</th><th>Slug</th><th>Chủ đề</th><th>Giá</th><th>Rating</th><th>Đăng ký</th><th>Bài học</th><th>Trạng thái</th><th>Hành động</th>
             </tr>
           </thead>
           <tbody>
-            {courses.map((course) => (
-              <tr key={course.id}>
-                <td>{course.id}</td>
-                <td className='td-strong'>{course.title}</td>
-                <td>{course.slug}</td>
-                <td>{course.topic?.name || 'Chưa gán'}</td>
-                <td>{course.price.toLocaleString('vi-VN')}đ</td>
-                <td>{course.published ? 'Published' : 'Draft'}</td>
+            {sortedCourses.map((c) => (
+              <tr key={c.id}>
+                <td>{c.id}</td>
+                <td className='td-strong'>{c.title}</td>
+                <td>{c.slug}</td>
+                <td>{c.topic?.name || 'Chưa gán'}</td>
+                <td>{(c.price || 0).toLocaleString('vi-VN')}đ</td>
+                <td>{c.ratingAvg ?? 0} ({c.ratingCount ?? 0})</td>
+                <td>{c.enrollmentCount ?? 0}</td>
+                <td>{c._count?.lessons ?? 0}</td>
+                <td><span className={`status-pill ${c.published ? 'is-published' : 'is-draft'}`}>{c.published ? 'Published' : 'Draft'}</span></td>
+                <td>
+                  <div className='admin-row'>
+                    <button className='admin-btn admin-btn-primary' type='button' onClick={() => void openEdit(c)}><i className='fa-solid fa-pen' /></button>
+                    <button className='admin-btn admin-btn-danger' type='button' onClick={() => void onDeleteCourse(c)}><i className='fa-solid fa-trash' /></button>
+                  </div>
+                </td>
               </tr>
             ))}
           </tbody>
         </table>
       </div>
+
+      {modalOpen && (
+        <div className='admin-modal-backdrop' role='dialog' aria-modal='true'>
+          <div className='admin-modal admin-modal-compact'>
+            <div className='admin-modal-header'>
+              <h4><i className='fa-solid fa-pen-ruler' /> {editing ? 'Chỉnh sửa khoá học' : 'Tạo khoá học mới'}</h4>
+              <div className='admin-row'>
+                {(['vi', 'en-US', 'de'] as Lang[]).map((l) => (
+                  <button key={l} type='button' className={`admin-btn ${langMode === l ? 'admin-btn-primary' : 'admin-btn-ghost'}`} onClick={() => setLangMode(l)}>{l === 'en-US' ? 'EN' : l.toUpperCase()}</button>
+                ))}
+                <button type='button' className='admin-btn admin-btn-ghost' onClick={closeModal}>Đóng</button>
+              </div>
+            </div>
+
+            <section className='admin-form-grid admin-form-grid-2col'>
+              <label className='admin-field'><span className='admin-label'>Tiêu đề *</span><input className='admin-input' value={form.title} onChange={(e) => setForm((p) => ({ ...p, title: e.target.value }))} /></label>
+              <label className='admin-field'><span className='admin-label'>Slug *</span><input className='admin-input' value={form.slug} onChange={(e) => setForm((p) => ({ ...p, slug: e.target.value }))} /></label>
+              <label className='admin-field'><span className='admin-label'>Chủ đề</span><select className='admin-input' value={form.topicId || ''} onChange={(e) => setForm((p) => ({ ...p, topicId: e.target.value ? Number(e.target.value) : undefined }))}><option value=''>-- Chưa gán --</option>{topics.map((t) => <option key={t.id} value={t.id}>{t.name}</option>)}</select></label>
+              <label className='admin-field'><span className='admin-label'>Ảnh khoá học (public URL)</span><input className='admin-input' value={form.thumbnail} onChange={(e) => setForm((p) => ({ ...p, thumbnail: e.target.value }))} /></label>
+              <label className='admin-field admin-field-full'><span className='admin-label'>Mô tả</span><textarea rows={2} className='admin-input' value={form.description} onChange={(e) => setForm((p) => ({ ...p, description: e.target.value }))} /></label>
+              <label className='admin-field'><span className='admin-label'>Giá (VND)</span><input type='number' className='admin-input' value={form.price} onChange={(e) => setForm((p) => ({ ...p, price: Number(e.target.value) }))} /></label>
+              <label className='admin-field'><span className='admin-label'>Rating TB</span><input type='number' min={0} max={5} step={0.1} className='admin-input' value={form.ratingAvg} onChange={(e) => setForm((p) => ({ ...p, ratingAvg: Number(e.target.value) }))} /></label>
+              <label className='admin-field'><span className='admin-label'>Lượt đánh giá</span><input type='number' className='admin-input' value={form.ratingCount} onChange={(e) => setForm((p) => ({ ...p, ratingCount: Number(e.target.value) }))} /></label>
+              <label className='admin-field'><span className='admin-label'>Số đăng ký</span><input type='number' className='admin-input' value={form.enrollmentCount} onChange={(e) => setForm((p) => ({ ...p, enrollmentCount: Number(e.target.value) }))} /></label>
+
+              <div className='admin-field admin-field-full'>
+                <span className='admin-label'>Dữ liệu đa ngôn ngữ ({langMode})</span>
+                <div className='admin-row'>
+                  <input className='admin-input' placeholder='Title i18n' value={(form.titleI18n[langMode] || '') as string} onChange={(e) => {
+                    const value = e.target.value
+                    if (langMode === 'vi') autoTranslateCourse('titleI18n', value)
+                    else setForm((p) => ({ ...p, titleI18n: { ...p.titleI18n, [langMode]: value } }))
+                  }} />
+                  <input className='admin-input' placeholder='Description i18n' value={(form.descriptionI18n[langMode] || '') as string} onChange={(e) => {
+                    const value = e.target.value
+                    if (langMode === 'vi') autoTranslateCourse('descriptionI18n', value)
+                    else setForm((p) => ({ ...p, descriptionI18n: { ...p.descriptionI18n, [langMode]: value } }))
+                  }} />
+                </div>
+              </div>
+
+              <label className='admin-field'><span className='admin-label'>Mục tiêu (mỗi dòng 1)</span><textarea rows={2} className='admin-input' value={form.objectivesText} onChange={(e) => setForm((p) => ({ ...p, objectivesText: e.target.value }))} /></label>
+              <label className='admin-field'><span className='admin-label'>Đối tượng phù hợp (mỗi dòng 1)</span><textarea rows={2} className='admin-input' value={form.audienceText} onChange={(e) => setForm((p) => ({ ...p, audienceText: e.target.value }))} /></label>
+              <label className='admin-field admin-field-full'><span className='admin-label'>Lợi ích (mỗi dòng 1)</span><textarea rows={2} className='admin-input' value={form.benefitsText} onChange={(e) => setForm((p) => ({ ...p, benefitsText: e.target.value }))} /></label>
+              <div className='admin-row admin-field-full' style={{ justifyContent: 'space-between' }}>
+                <label className='admin-check'><input type='checkbox' checked={form.published} onChange={(e) => setForm((p) => ({ ...p, published: e.target.checked }))} /><span>Xuất bản khoá học</span></label>
+                <button className='admin-btn admin-btn-save' onClick={() => void submitCourse()} disabled={saving}><i className='fa-solid fa-floppy-disk' /> {editing ? 'Cập nhật khoá học' : 'Tạo khoá học'}</button>
+              </div>
+            </section>
+
+            {editing && (
+              <section className='admin-curriculum-grid' style={{ marginTop: 10 }}>
+                <article className='admin-card'>
+                  <h4 className='admin-card-title'><i className='fa-solid fa-list-check' /> Bài học / Module / Video</h4>
+                  <div className='admin-table-wrap'>
+                    <table className='admin-table'>
+                      <thead><tr><th>ID</th><th>Tiêu đề</th><th>Slug</th><th>Order</th><th>Trạng thái</th><th>Hành động</th></tr></thead>
+                      <tbody>
+                        {lessons.map((l) => (
+                          <tr key={l.id}>
+                            <td>{l.id}</td><td>{l.title}</td><td>{l.slug}</td><td>{l.order}</td><td>{l.published ? 'Published' : 'Draft'}</td>
+                            <td>
+                              <div className='admin-row'>
+                                <button className='admin-btn admin-btn-primary' type='button' onClick={() => void editLesson(l.id)}><i className='fa-solid fa-pen' /></button>
+                                <button className='admin-btn admin-btn-danger' type='button' onClick={() => void deleteLesson(l.id)}><i className='fa-solid fa-trash' /></button>
+                              </div>
+                            </td>
+                          </tr>
+                        ))}
+                      </tbody>
+                    </table>
+                  </div>
+                </article>
+
+                <article className='admin-card'>
+                  <h4 className='admin-card-title'><i className='fa-solid fa-plus' /> {editingLessonId ? 'Sửa bài học' : 'Tạo bài học mới'}</h4>
+                  <div className='admin-form-grid'>
+                    <label className='admin-field'><span className='admin-label'>Tiêu đề</span><input className='admin-input' value={lessonDraft.title} onChange={(e) => setLessonDraft((p) => ({ ...p, title: e.target.value }))} /></label>
+                    <label className='admin-field'><span className='admin-label'>Slug</span><input className='admin-input' value={lessonDraft.slug} onChange={(e) => setLessonDraft((p) => ({ ...p, slug: e.target.value }))} /></label>
+                    <label className='admin-field'><span className='admin-label'>Thứ tự</span><input type='number' className='admin-input' value={lessonDraft.order} onChange={(e) => setLessonDraft((p) => ({ ...p, order: Number(e.target.value) }))} /></label>
+                    <label className='admin-check'><input type='checkbox' checked={lessonDraft.published} onChange={(e) => setLessonDraft((p) => ({ ...p, published: e.target.checked }))} /><span>Published</span></label>
+                    <label className='admin-field admin-field-full'><span className='admin-label'>Mô tả bài học</span><textarea rows={2} className='admin-input' value={lessonDraft.description || ''} onChange={(e) => setLessonDraft((p) => ({ ...p, description: e.target.value }))} /></label>
+                    <label className='admin-field admin-field-full'><span className='admin-label'>Nội dung bài học</span><textarea rows={2} className='admin-input' value={lessonDraft.content || ''} onChange={(e) => setLessonDraft((p) => ({ ...p, content: e.target.value }))} /></label>
+
+                    <div className='admin-field admin-field-full'>
+                      <span className='admin-label'>Lesson i18n ({langMode})</span>
+                      <div className='admin-row'>
+                        <input className='admin-input' placeholder='Lesson title i18n' value={(lessonDraft.titleI18n[langMode] || '') as string} onChange={(e) => {
+                          const value = e.target.value
+                          if (langMode === 'vi') autoTranslateLesson('lessonTitle', value)
+                          else setLessonDraft((p) => ({ ...p, titleI18n: { ...p.titleI18n, [langMode]: value } }))
+                        }} />
+                        <input className='admin-input' placeholder='Lesson desc i18n' value={(lessonDraft.descriptionI18n[langMode] || '') as string} onChange={(e) => {
+                          const value = e.target.value
+                          if (langMode === 'vi') autoTranslateLesson('lessonDesc', value)
+                          else setLessonDraft((p) => ({ ...p, descriptionI18n: { ...p.descriptionI18n, [langMode]: value } }))
+                        }} />
+                      </div>
+                    </div>
+
+                    {lessonDraft.modules.map((m, mi) => (
+                      <div className='admin-card admin-field-full' key={`m-${mi}`}>
+                        <div className='admin-row' style={{ justifyContent: 'space-between' }}>
+                          <strong>Module #{mi + 1}</strong>
+                          <button className='admin-btn admin-btn-danger' type='button' onClick={() => removeModule(mi)}><i className='fa-solid fa-trash' /></button>
+                        </div>
+                        <div className='admin-form-grid'>
+                          <label className='admin-field'><span className='admin-label'>Tiêu đề module</span><input className='admin-input' value={m.title || ''} onChange={(e) => updateModule(mi, { title: e.target.value })} /></label>
+                          <label className='admin-field'><span className='admin-label'>Mô tả module</span><input className='admin-input' value={m.description || ''} onChange={(e) => updateModule(mi, { description: e.target.value })} /></label>
+                          <div className='admin-field admin-field-full'>
+                            <span className='admin-label'>Module i18n ({langMode})</span>
+                            <div className='admin-row'>
+                              <input className='admin-input' placeholder='Module title i18n' value={(m.titleI18n?.[langMode] || '') as string} onChange={(e) => {
+                                const value = e.target.value
+                                if (langMode === 'vi') autoTranslateLesson('moduleTitle', value, mi)
+                                else updateModule(mi, { titleI18n: { ...m.titleI18n, [langMode]: value } })
+                              }} />
+                              <input className='admin-input' placeholder='Module desc i18n' value={(m.descriptionI18n?.[langMode] || '') as string} onChange={(e) => {
+                                const value = e.target.value
+                                if (langMode === 'vi') autoTranslateLesson('moduleDesc', value, mi)
+                                else updateModule(mi, { descriptionI18n: { ...m.descriptionI18n, [langMode]: value } })
+                              }} />
+                            </div>
+                          </div>
+
+                          {m.videos.map((v, vi) => (
+                            <div className='admin-card admin-field-full' key={`v-${mi}-${vi}`}>
+                              <div className='admin-row' style={{ justifyContent: 'space-between' }}>
+                                <strong>Video #{vi + 1}</strong>
+                                <button className='admin-btn admin-btn-danger' type='button' onClick={() => removeVideo(mi, vi)}><i className='fa-solid fa-trash' /></button>
+                              </div>
+                              <div className='admin-row'>
+                                <input className='admin-input' placeholder='Tiêu đề video' value={v.title || ''} onChange={(e) => updateVideo(mi, vi, { title: e.target.value })} />
+                                <input className='admin-input' placeholder='Mô tả video' value={v.description || ''} onChange={(e) => updateVideo(mi, vi, { description: e.target.value })} />
+                                <input type='number' className='admin-input' placeholder='Duration sec' value={v.durationSec || 0} onChange={(e) => updateVideo(mi, vi, { durationSec: Number(e.target.value) })} />
+                              </div>
+                              <div className='admin-row'>
+                                <input className='admin-input' placeholder='Video title i18n' value={(v.titleI18n?.[langMode] || '') as string} onChange={(e) => {
+                                  const value = e.target.value
+                                  if (langMode === 'vi') autoTranslateLesson('videoTitle', value, mi, vi)
+                                  else updateVideo(mi, vi, { titleI18n: { ...v.titleI18n, [langMode]: value } })
+                                }} />
+                                <input className='admin-input' placeholder='Video desc i18n' value={(v.descriptionI18n?.[langMode] || '') as string} onChange={(e) => {
+                                  const value = e.target.value
+                                  if (langMode === 'vi') autoTranslateLesson('videoDesc', value, mi, vi)
+                                  else updateVideo(mi, vi, { descriptionI18n: { ...v.descriptionI18n, [langMode]: value } })
+                                }} />
+                              </div>
+                              <div className='admin-row'>
+                                <label className='admin-btn admin-btn-ghost' style={{ cursor: 'pointer' }}>
+                                  <i className='fa-solid fa-upload' /> {uploadingFor === `${editingLessonId}-${m.id}` ? 'Đang xử lý...' : 'Upload video -> HLS'}
+                                  <input type='file' accept='video/*' style={{ display: 'none' }} onChange={(e) => void uploadVideo(editingLessonId || 0, m.id, e.target.files?.[0])} />
+                                </label>
+                              </div>
+                            </div>
+                          ))}
+
+                          <button className='admin-btn admin-btn-ghost' type='button' onClick={() => addVideo(mi)}><i className='fa-solid fa-plus' /> Thêm video</button>
+                        </div>
+                      </div>
+                    ))}
+
+                    <div className='admin-row'>
+                      <button className='admin-btn admin-btn-ghost' type='button' onClick={addModule}><i className='fa-solid fa-plus' /> Thêm module</button>
+                      <button className='admin-btn admin-btn-save' type='button' onClick={() => void saveLesson()}><i className='fa-solid fa-floppy-disk' /> {editingLessonId ? 'Cập nhật bài học' : 'Tạo bài học'}</button>
+                    </div>
+                  </div>
+                </article>
+              </section>
+            )}
+          </div>
+        </div>
+      )}
     </section>
   )
 }
diff --git a/backend/ayanavitabackend/app/api/prisma/migrations/202603070002_course_lesson_module_video_i18n/migration.sql b/backend/ayanavitabackend/app/api/prisma/migrations/202603070002_course_lesson_module_video_i18n/migration.sql
new file mode 100644
index 0000000000000000000000000000000000000000..b277037e6b6306c5667bd73ab45a86b9e4d599ed
--- /dev/null
+++ b/backend/ayanavitabackend/app/api/prisma/migrations/202603070002_course_lesson_module_video_i18n/migration.sql
@@ -0,0 +1,62 @@
+-- Course metadata + i18n
+ALTER TABLE `Course`
+  ADD COLUMN `titleI18n` JSON NULL,
+  ADD COLUMN `descriptionI18n` JSON NULL,
+  ADD COLUMN `shortDescriptionI18n` JSON NULL,
+  ADD COLUMN `objectives` JSON NULL,
+  ADD COLUMN `targetAudience` JSON NULL,
+  ADD COLUMN `benefits` JSON NULL,
+  ADD COLUMN `ratingAvg` DOUBLE NOT NULL DEFAULT 0,
+  ADD COLUMN `ratingCount` INTEGER NOT NULL DEFAULT 0,
+  ADD COLUMN `enrollmentCount` INTEGER NOT NULL DEFAULT 0;
+
+-- Lesson metadata + i18n
+ALTER TABLE `Lesson`
+  ADD COLUMN `description` LONGTEXT NULL,
+  ADD COLUMN `titleI18n` JSON NULL,
+  ADD COLUMN `descriptionI18n` JSON NULL;
+
+-- Lesson module table
+CREATE TABLE `LessonModule` (
+  `id` INTEGER NOT NULL AUTO_INCREMENT,
+  `lessonId` INTEGER NOT NULL,
+  `title` VARCHAR(191) NOT NULL,
+  `description` LONGTEXT NULL,
+  `titleI18n` JSON NULL,
+  `descriptionI18n` JSON NULL,
+  `order` INTEGER NOT NULL DEFAULT 0,
+  `published` BOOLEAN NOT NULL DEFAULT true,
+  `createdAt` DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
+  `updatedAt` DATETIME(3) NOT NULL,
+
+  INDEX `LessonModule_lessonId_order_idx`(`lessonId`, `order`),
+  PRIMARY KEY (`id`)
+) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
+
+-- Lesson video table
+CREATE TABLE `LessonVideo` (
+  `id` INTEGER NOT NULL AUTO_INCREMENT,
+  `moduleId` INTEGER NOT NULL,
+  `title` VARCHAR(191) NOT NULL,
+  `description` LONGTEXT NULL,
+  `titleI18n` JSON NULL,
+  `descriptionI18n` JSON NULL,
+  `sourceUrl` VARCHAR(191) NULL,
+  `hlsPlaylistKey` VARCHAR(191) NULL,
+  `durationSec` INTEGER NOT NULL DEFAULT 0,
+  `order` INTEGER NOT NULL DEFAULT 0,
+  `published` BOOLEAN NOT NULL DEFAULT true,
+  `createdAt` DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
+  `updatedAt` DATETIME(3) NOT NULL,
+
+  INDEX `LessonVideo_moduleId_order_idx`(`moduleId`, `order`),
+  PRIMARY KEY (`id`)
+) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
+
+ALTER TABLE `LessonModule`
+  ADD CONSTRAINT `LessonModule_lessonId_fkey`
+  FOREIGN KEY (`lessonId`) REFERENCES `Lesson`(`id`) ON DELETE CASCADE ON UPDATE CASCADE;
+
+ALTER TABLE `LessonVideo`
+  ADD CONSTRAINT `LessonVideo_moduleId_fkey`
+  FOREIGN KEY (`moduleId`) REFERENCES `LessonModule`(`id`) ON DELETE CASCADE ON UPDATE CASCADE;
diff --git a/backend/ayanavitabackend/app/api/prisma/schema.prisma b/backend/ayanavitabackend/app/api/prisma/schema.prisma
index 06d005c9cdfb352afe6fbba8fe053b1480d61aeb..3a4723e3487bc543dd72c2b83195875e5d3f200c 100644
--- a/backend/ayanavitabackend/app/api/prisma/schema.prisma
+++ b/backend/ayanavitabackend/app/api/prisma/schema.prisma
@@ -221,115 +221,166 @@ model ServiceReview {
   userId     Int?
   stars      Int
   comment    String?  @db.Text
   customerName String? @db.VarChar(255)
   createdAt  DateTime @default(now())
   updatedAt  DateTime @updatedAt

   service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)
   user    User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

   @@index([serviceId])
 }


 model RegistrationOtp {
   id        Int      @id @default(autoincrement())
   email     String   @unique
   code      String   @db.VarChar(6)
   expiresAt DateTime
   usedAt    DateTime?
   createdAt DateTime @default(now())
   updatedAt DateTime @updatedAt
 }

 model Course {
-  id          Int      @id @default(autoincrement())
-  topicId     Int?
-  title       String
-  slug        String   @unique
-  description String?
-  thumbnail   String?
-  price       Int      @default(0)
-  published   Boolean  @default(false)
-  createdAt   DateTime @default(now())
-  updatedAt   DateTime @updatedAt
+  id                  Int      @id @default(autoincrement())
+  topicId             Int?
+  title               String
+  slug                String   @unique
+  description         String?
+  thumbnail           String?
+  price               Int      @default(0)
+  published           Boolean  @default(false)
+  titleI18n           Json?
+  descriptionI18n     Json?
+  shortDescriptionI18n Json?
+  objectives          Json?
+  targetAudience      Json?
+  benefits            Json?
+  ratingAvg           Float    @default(0)
+  ratingCount         Int      @default(0)
+  enrollmentCount     Int      @default(0)
+  createdAt           DateTime @default(now())
+  updatedAt           DateTime @updatedAt

   lessons     Lesson[]
   enrollments Enrollment[]
   topic       CourseTopic? @relation(fields: [topicId], references: [id], onDelete: Restrict)

   // ✅ ADD
   orderItems OrderItem[] // <— opposite for OrderItem.course

   @@index([topicId])
 }

 model CourseTopic {
   id          Int      @id @default(autoincrement())
   name        String   @unique @db.VarChar(120)
   description String?  @db.VarChar(255)
   createdAt   DateTime @default(now())
   updatedAt   DateTime @updatedAt

   courses      Course[]
   translations CourseTopicTranslation[]
 }

 model CourseTopicTranslation {
   id          Int      @id @default(autoincrement())
   topicId     Int
   locale      String   @db.VarChar(10)
   name        String   @db.VarChar(120)
   description String?  @db.VarChar(255)
   createdAt   DateTime @default(now())
   updatedAt   DateTime @updatedAt

   topic CourseTopic @relation(fields: [topicId], references: [id], onDelete: Cascade)

   @@unique([topicId, locale])
   @@index([locale])
 }

 model Lesson {
-  id        Int              @id @default(autoincrement())
-  courseId  Int
-  title     String
-  slug      String
-  content   String?          @db.LongText
-  videoUrl  String?
-  order     Int              @default(0)
-  published Boolean          @default(false)
-  createdAt DateTime         @default(now())
-  updatedAt DateTime         @updatedAt
-  course    Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
-  progress  LessonProgress[]
+  id              Int              @id @default(autoincrement())
+  courseId        Int
+  title           String
+  slug            String
+  description     String?
+  content         String?          @db.LongText
+  videoUrl        String?
+  titleI18n       Json?
+  descriptionI18n Json?
+  order           Int              @default(0)
+  published       Boolean          @default(false)
+  createdAt       DateTime         @default(now())
+  updatedAt       DateTime         @updatedAt
+  course          Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
+  progress        LessonProgress[]
+  modules         LessonModule[]

   @@unique([courseId, slug])
   @@index([courseId, order])
 }

+model LessonModule {
+  id              Int          @id @default(autoincrement())
+  lessonId        Int
+  title           String
+  description     String?
+  titleI18n       Json?
+  descriptionI18n Json?
+  order           Int          @default(0)
+  published       Boolean      @default(true)
+  createdAt       DateTime     @default(now())
+  updatedAt       DateTime     @updatedAt
+
+  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)
+  videos LessonVideo[]
+
+  @@index([lessonId, order])
+}
+
+model LessonVideo {
+  id              Int          @id @default(autoincrement())
+  moduleId        Int
+  title           String
+  description     String?
+  titleI18n       Json?
+  descriptionI18n Json?
+  sourceUrl       String?
+  hlsPlaylistKey  String?
+  durationSec     Int          @default(0)
+  order           Int          @default(0)
+  published       Boolean      @default(true)
+  createdAt       DateTime     @default(now())
+  updatedAt       DateTime     @updatedAt
+
+  module LessonModule @relation(fields: [moduleId], references: [id], onDelete: Cascade)
+
+  @@index([moduleId, order])
+}
+
 model Enrollment {
   id       Int @id @default(autoincrement())
   userId   Int
   courseId Int
   orderId  Int

   createdAt DateTime @default(now())

   status     EnrollmentStatus @default(ACTIVE)
   enrolledAt DateTime         @default(now())
   updatedAt  DateTime         @updatedAt
   user       User             @relation(fields: [userId], references: [id], onDelete: Cascade)
   course     Course           @relation(fields: [courseId], references: [id], onDelete: Restrict)
   order      Order            @relation(fields: [orderId], references: [id], onDelete: Cascade)

   @@unique([userId, courseId])
   @@index([courseId])
   @@index([orderId])
 }

 model LessonProgress {
   id           Int      @id @default(autoincrement())
   userId       Int
   lessonId     Int
   completed    Boolean  @default(false)
diff --git a/backend/ayanavitabackend/app/api/prisma/seed.ts b/backend/ayanavitabackend/app/api/prisma/seed.ts
index 849272ae42ceca15331faafa903b4718f92cf5da..40a3c801ab714563a28b46b9a2d71d044355312c 100644
--- a/backend/ayanavitabackend/app/api/prisma/seed.ts
+++ b/backend/ayanavitabackend/app/api/prisma/seed.ts
@@ -5,57 +5,51 @@ const prisma = new PrismaClient()

 function slugify(input: string) {
   return input
     .toLowerCase()
     .trim()
     .normalize('NFD')
     .replace(/[\u0300-\u036f]/g, '')
     .replace(/[^a-z0-9]+/g, '-')
     .replace(/(^-|-$)+/g, '')
 }

 async function main() {
   const passwordHash = await bcrypt.hash('123456', 10)

   const user = await prisma.user.upsert({
     where: { email: 'test@ayanavita.com' },
     update: {},
     create: {
       email: 'test@ayanavita.com',
       password: passwordHash,
       name: 'Test User',
       role: 'USER',
     },
   })

-  const seedCourses = [
-    { title: 'Course 1 - Basic', price: 99000 },
-    { title: 'Course 2 - Pro', price: 199000 },
-    { title: 'Course 3 - Master', price: 299000 },
-  ].map((c) => ({ ...c, slug: slugify(c.title) }))
-
-  await prisma.course.createMany({ data: seedCourses, skipDuplicates: true })
+  // Course/Lesson sample seeds removed as requested

   const branchSeeds = [
     { code: 'HCM_Q1', name: 'AYANAVITA • Quận 1 (HCM)', address: '12 Nguyễn Huệ, Quận 1, TP.HCM', phone: '0900000001' },
     { code: 'HN_CG', name: 'AYANAVITA • Cầu Giấy (HN)', address: '88 Trần Thái Tông, Cầu Giấy, Hà Nội', phone: '0900000002' },
     { code: 'DN_HC', name: 'AYANAVITA • Hải Châu (ĐN)', address: '25 Bạch Đằng, Hải Châu, Đà Nẵng', phone: '0900000003' },
   ]

   const serviceSeeds = [
     {
       name: 'Chăm sóc da chuyên sâu 👏',
       categoryName: 'Chăm sóc da',
       goals: ['restore', 'bright'],
       suitableFor: ['Da xỉn màu', 'Da thiếu ẩm'],
       durationMin: 75,
       price: 590000,
       ratingAvg: 4.9,
       bookedCount: 1320,
       tag: 'Best seller',
       imageUrl: 'https://images.unsplash.com/photo-1515377905703-c4788e51af15?auto=format&fit=crop&w=1200&q=70',
       description: 'Liệu trình làm sạch và phục hồi da chuyên sâu.',
     },
     {
       name: 'Massage thư giãn toàn thân 🤗',
       categoryName: 'Chăm sóc cơ thể',
       goals: ['relax'],
diff --git a/backend/ayanavitabackend/app/api/src/courses/courses.service.ts b/backend/ayanavitabackend/app/api/src/courses/courses.service.ts
index 778364facfd7f4f682dcc687fb276695e5fc6458..7929163457e2b58e73bb24d688a6d6e2d1cc7df8 100644
--- a/backend/ayanavitabackend/app/api/src/courses/courses.service.ts
+++ b/backend/ayanavitabackend/app/api/src/courses/courses.service.ts
@@ -1,334 +1,232 @@
-import { ConflictException, ForbiddenException, Injectable, NotFoundException } from "@nestjs/common";
+import { BadRequestException, ConflictException, ForbiddenException, Injectable, NotFoundException } from "@nestjs/common";
 import { PrismaService } from "../prisma/prisma.service";
 import { EnrollmentsService } from "../enrollments/enrollments.service";
 import { CreateCourseDto } from "./dto/create-course.dto";
 import { UpdateCourseDto } from "./dto/update-course.dto";
 import { Prisma, ProgressStatus } from "@prisma/client";

 type JwtUser = { sub: number; role: string }
+
 @Injectable()
 export class CoursesService {
   constructor(
     private readonly prisma: PrismaService,
     private readonly enrollments: EnrollmentsService
   ) {}
-async lessonsOutline(user: JwtUser, courseId: number) {
+
+  private readonly baseCourseSelect = {
+    id: true,
+    topicId: true,
+    title: true,
+    slug: true,
+    description: true,
+    thumbnail: true,
+    price: true,
+    published: true,
+    titleI18n: true,
+    descriptionI18n: true,
+    shortDescriptionI18n: true,
+    objectives: true,
+    targetAudience: true,
+    benefits: true,
+    ratingAvg: true,
+    ratingCount: true,
+    enrollmentCount: true,
+    createdAt: true,
+    updatedAt: true,
+    topic: { select: { id: true, name: true } },
+    _count: { select: { lessons: true } },
+  } as const
+
+  private buildCreateCoursePayload(dto: CreateCourseDto & { title: string }): Prisma.CourseUncheckedCreateInput {
+    return {
+      title: dto.title,
+      slug: dto.slug,
+      ...(dto.description !== undefined ? { description: dto.description } : {}),
+      ...(dto.thumbnail !== undefined ? { thumbnail: dto.thumbnail } : {}),
+      ...(dto.price !== undefined ? { price: dto.price } : {}),
+      ...(dto.published !== undefined ? { published: dto.published } : {}),
+      ...(dto.topicId !== undefined ? { topicId: dto.topicId } : {}),
+      ...(dto.titleI18n !== undefined ? { titleI18n: dto.titleI18n as any } : {}),
+      ...(dto.descriptionI18n !== undefined ? { descriptionI18n: dto.descriptionI18n as any } : {}),
+      ...(dto.shortDescriptionI18n !== undefined ? { shortDescriptionI18n: dto.shortDescriptionI18n as any } : {}),
+      ...(dto.objectives !== undefined ? { objectives: dto.objectives as any } : {}),
+      ...(dto.targetAudience !== undefined ? { targetAudience: dto.targetAudience as any } : {}),
+      ...(dto.benefits !== undefined ? { benefits: dto.benefits as any } : {}),
+      ...(dto.ratingAvg !== undefined ? { ratingAvg: dto.ratingAvg } : {}),
+      ...(dto.ratingCount !== undefined ? { ratingCount: dto.ratingCount } : {}),
+      ...(dto.enrollmentCount !== undefined ? { enrollmentCount: dto.enrollmentCount } : {}),
+    }
+  }
+
+  private buildUpdateCoursePayload(dto: UpdateCourseDto): Prisma.CourseUncheckedUpdateInput {
+    return {
+      ...(dto.title !== undefined ? { title: dto.title } : {}),
+      ...(dto.slug !== undefined ? { slug: dto.slug } : {}),
+      ...(dto.description !== undefined ? { description: dto.description } : {}),
+      ...(dto.thumbnail !== undefined ? { thumbnail: dto.thumbnail } : {}),
+      ...(dto.price !== undefined ? { price: dto.price } : {}),
+      ...(dto.published !== undefined ? { published: dto.published } : {}),
+      ...(dto.topicId !== undefined ? { topicId: dto.topicId } : {}),
+      ...(dto.titleI18n !== undefined ? { titleI18n: dto.titleI18n as any } : {}),
+      ...(dto.descriptionI18n !== undefined ? { descriptionI18n: dto.descriptionI18n as any } : {}),
+      ...(dto.shortDescriptionI18n !== undefined ? { shortDescriptionI18n: dto.shortDescriptionI18n as any } : {}),
+      ...(dto.objectives !== undefined ? { objectives: dto.objectives as any } : {}),
+      ...(dto.targetAudience !== undefined ? { targetAudience: dto.targetAudience as any } : {}),
+      ...(dto.benefits !== undefined ? { benefits: dto.benefits as any } : {}),
+      ...(dto.ratingAvg !== undefined ? { ratingAvg: dto.ratingAvg } : {}),
+      ...(dto.ratingCount !== undefined ? { ratingCount: dto.ratingCount } : {}),
+      ...(dto.enrollmentCount !== undefined ? { enrollmentCount: dto.enrollmentCount } : {}),
+    }
+  }
+
+  async lessonsOutline(user: JwtUser, courseId: number) {
     const course = await this.prisma.course.findUnique({
       where: { id: courseId },
       select: { id: true, published: true },
     })
     if (!course) throw new NotFoundException('Course not found')

-    // USER không xem outline nếu course unpublished (ẩn 404)
     if (user.role !== 'ADMIN' && !course.published) {
       throw new NotFoundException('Course not found')
     }

-    // USER chỉ thấy lesson published=true; ADMIN thấy hết
-    const lessons = await this.prisma.lesson.findMany({
+    return this.prisma.lesson.findMany({
       where: {
         courseId,
         ...(user.role === 'ADMIN' ? {} : { published: true }),
       },
       select: {
         id: true,
         courseId: true,
         title: true,
         slug: true,
         order: true,
         published: true,
         createdAt: true,
         updatedAt: true,
       },
       orderBy: [{ order: 'asc' }, { id: 'asc' }],
     })
-
-    return lessons
   }
-  // =========================
-  // PUBLIC/COMMON (đã login)
-  // =========================
+
   findAll() {
     return this.prisma.course.findMany({
-      select: {
-        id: true,
-        topicId: true,
-        title: true,
-        slug: true,
-        description: true,
-        thumbnail: true,
-        price: true,
-        published: true,
-        createdAt: true,
-        updatedAt: true,
-        topic: { select: { id: true, name: true } },
-        _count: { select: { lessons: true } },
-      },
+      select: this.baseCourseSelect,
       orderBy: { id: "desc" },
     });
   }

   async findOne(id: number) {
     const course = await this.prisma.course.findUnique({
       where: { id },
-      select: {
-        id: true,
-        topicId: true,
-        title: true,
-        slug: true,
-        description: true,
-        thumbnail: true,
-        price: true,
-        published: true,
-        createdAt: true,
-        updatedAt: true,
-        topic: { select: { id: true, name: true } },
-        _count: { select: { lessons: true } },
-      },
+      select: this.baseCourseSelect,
     });
     if (!course) throw new NotFoundException("Course not found");
     return course;
   }

-  // =========================
-  // ADMIN CRUD
-  // =========================
   async create(dto: CreateCourseDto) {
+    if (!dto.title?.trim()) {
+      throw new BadRequestException("Title is required")
+    }
+
     try {
       return await this.prisma.course.create({
-        data: dto,
-        select: {
-          id: true,
-          topicId: true,
-          title: true,
-          slug: true,
-          description: true,
-          thumbnail: true,
-          price: true,
-          published: true,
-          createdAt: true,
-          updatedAt: true,
-          topic: { select: { id: true, name: true } },
-        },
+        data: this.buildCreateCoursePayload({ ...dto, title: dto.title.trim() }),
+        select: this.baseCourseSelect,
       });
     } catch (e) {
       if (e instanceof Prisma.PrismaClientKnownRequestError && e.code === "P2002") {
         const target = (e.meta as any)?.target;
         if (Array.isArray(target) ? target.includes("slug") : String(target).includes("slug")) {
           throw new ConflictException("Slug already exists");
         }
         throw new ConflictException("Unique constraint failed");
       }
       throw e;
     }
   }

   async update(id: number, dto: UpdateCourseDto) {
     await this.ensureCourseExists(id);
     return this.prisma.course.update({
       where: { id },
-      data: dto,
-      select: {
-        id: true,
-        topicId: true,
-        title: true,
-        slug: true,
-        description: true,
-        thumbnail: true,
-        price: true,
-        published: true,
-        createdAt: true,
-        updatedAt: true,
-      },
+      data: this.buildUpdateCoursePayload(dto),
+      select: this.baseCourseSelect,
     });
   }

   async remove(id: number) {
     await this.ensureCourseExists(id);
-    return this.prisma.course.delete({
-      where: { id },
-      select: { id: true },
-    });
+    return this.prisma.course.delete({ where: { id }, select: { id: true } });
   }

   async listLessons(user: { sub: number; role: string }, courseId: number) {
-    // 1) course tồn tại
-    const course = await this.prisma.course.findUnique({
-      where: { id: courseId },
-      select: { id: true, published: true },
-    });
+    const course = await this.prisma.course.findUnique({ where: { id: courseId }, select: { id: true, published: true } });
     if (!course) throw new NotFoundException("Course not found");
-
-    // 2) Gate enroll (ADMIN bypass)
     await this.enrollments.assertEnrolledOrAdmin(user, courseId);
+    if (user.role !== "ADMIN" && !course.published) throw new NotFoundException("Course not found");

-    // 3) USER không xem course unpublished (ẩn 404)
-    if (user.role !== "ADMIN" && !course.published) {
-      throw new NotFoundException("Course not found");
-    }
-
-    // 4) Lấy lessons theo quyền
     const lessons = await this.prisma.lesson.findMany({
-      where: {
-        courseId,
-        ...(user.role === "ADMIN" ? {} : { published: true }),
-      },
-      select: {
-        id: true,
-        courseId: true,
-        title: true,
-        slug: true,
-        order: true,
-        published: true,
-        createdAt: true,
-        updatedAt: true,
-      },
+      where: { courseId, ...(user.role === "ADMIN" ? {} : { published: true }) },
+      select: { id: true, courseId: true, title: true, slug: true, order: true, published: true, createdAt: true, updatedAt: true },
       orderBy: [{ order: "asc" }, { id: "asc" }],
     });

-    // ADMIN: không lock
-    if (user.role === "ADMIN") {
-      return lessons.map((l) => ({
-        ...l,
-        locked: false,
-        lockReason: null,
-        progress: null,
-      }));
-    }
+    if (user.role === "ADMIN") return lessons.map((l) => ({ ...l, locked: false, lockReason: null, progress: null }));

-    // 5) USER: lấy progress của user cho các lesson trong course này
     const progressRows = await this.prisma.lessonProgress.findMany({
-      where: {
-        userId: user.sub,
-        lessonId: { in: lessons.map((l) => l.id) },
-      },
-      select: {
-        lessonId: true,
-        status: true,
-        percent: true,
-        lastPositionSec: true,
-        lastOpenedAt: true,
-        completedAt: true,
-        updatedAt: true,
-      },
+      where: { userId: user.sub, lessonId: { in: lessons.map((l) => l.id) } },
+      select: { lessonId: true, status: true, percent: true, lastPositionSec: true, lastOpenedAt: true, completedAt: true, updatedAt: true },
     });

     const progressMap = new Map(progressRows.map((p) => [p.lessonId, p]));
-
-    // 6) Sequential unlock
     let prevCompleted = true;
-
-    const result = lessons.map((lesson, idx) => {
+    return lessons.map((lesson, idx) => {
       const progress = progressMap.get(lesson.id) ?? null;
-
       const locked = idx === 0 ? false : prevCompleted === false;
       const lockReason = locked ? "PREV_NOT_COMPLETED" : null;
-
       prevCompleted = progress?.status === ProgressStatus.COMPLETED;
-
-      return {
-        ...lesson,
-        locked,
-        lockReason,
-        progress,
-      };
+      return { ...lesson, locked, lockReason, progress };
     });
-
-    return result;
   }

-  /**
-   * ✅ NEW: Lesson detail (có content) + enforce sequential lock để không lách URL
-   * GET /courses/:courseId/lessons/:lessonId
-   */
   async getLessonDetail(user: { sub: number; role: string }, courseId: number, lessonId: number) {
-    // 1) course tồn tại
-    const course = await this.prisma.course.findUnique({
-      where: { id: courseId },
-      select: { id: true, published: true },
-    });
+    const course = await this.prisma.course.findUnique({ where: { id: courseId }, select: { id: true, published: true } });
     if (!course) throw new NotFoundException("Course not found");
-
-    // 2) Gate enroll (ADMIN bypass)
     await this.enrollments.assertEnrolledOrAdmin(user, courseId);
+    if (user.role !== "ADMIN" && !course.published) throw new NotFoundException("Course not found");

-    // 3) USER không xem course unpublished (ẩn 404)
-    if (user.role !== "ADMIN" && !course.published) {
-      throw new NotFoundException("Course not found");
-    }
-
-    // 4) Lấy lesson thuộc course
     const lesson = await this.prisma.lesson.findFirst({
       where: { id: lessonId, courseId },
-      select: {
-        id: true,
-        courseId: true,
-        title: true,
-        slug: true,
-        content: true,
-        videoUrl: true,
-        order: true,
-        published: true,
-        createdAt: true,
-        updatedAt: true,
-      },
+      select: { id: true, courseId: true, title: true, slug: true, content: true, videoUrl: true, order: true, published: true, createdAt: true, updatedAt: true },
     });
     if (!lesson) throw new NotFoundException("Lesson not found");
+    if (user.role !== "ADMIN" && !lesson.published) throw new NotFoundException("Lesson not found");

-    // 5) USER không xem lesson unpublished (ẩn 404)
-    if (user.role !== "ADMIN" && !lesson.published) {
-      throw new NotFoundException("Lesson not found");
-    }
-
-    // 6) USER: enforce sequential lock
     if (user.role !== "ADMIN") {
-      const orderedLessons = await this.prisma.lesson.findMany({
-        where: { courseId, published: true },
-        select: { id: true },
-        orderBy: [{ order: "asc" }, { id: "asc" }],
-      });
-
+      const orderedLessons = await this.prisma.lesson.findMany({ where: { courseId, published: true }, select: { id: true }, orderBy: [{ order: "asc" }, { id: "asc" }] });
       const idx = orderedLessons.findIndex((l) => l.id === lessonId);
       if (idx < 0) throw new NotFoundException("Lesson not found");
-
       if (idx > 0) {
         const prevLessonId = orderedLessons[idx - 1].id;
-        const prevProgress = await this.prisma.lessonProgress.findUnique({
-          where: { userId_lessonId: { userId: user.sub, lessonId: prevLessonId } },
-          select: { status: true },
-        });
-
+        const prevProgress = await this.prisma.lessonProgress.findUnique({ where: { userId_lessonId: { userId: user.sub, lessonId: prevLessonId } }, select: { status: true } });
         const unlocked = prevProgress?.status === ProgressStatus.COMPLETED;
         if (!unlocked) throw new ForbiddenException("Lesson locked");
       }
     }

-    // 7) progress của lesson hiện tại
     const progress = await this.prisma.lessonProgress.findUnique({
       where: { userId_lessonId: { userId: user.sub, lessonId } },
-      select: {
-        lessonId: true,
-        status: true,
-        percent: true,
-        lastPositionSec: true,
-        lastOpenedAt: true,
-        completedAt: true,
-        updatedAt: true,
-      },
+      select: { lessonId: true, status: true, percent: true, lastPositionSec: true, lastOpenedAt: true, completedAt: true, updatedAt: true },
     });

-    return {
-      ...lesson,
-      progress: progress ?? null,
-    };
+    return { ...lesson, progress: progress ?? null };
   }

-  // helper
   private async ensureCourseExists(id: number) {
-    const ok = await this.prisma.course.findUnique({
-      where: { id },
-      select: { id: true },
-    });
+    const ok = await this.prisma.course.findUnique({ where: { id }, select: { id: true } });
     if (!ok) throw new NotFoundException("Course not found");
   }
 }
diff --git a/backend/ayanavitabackend/app/api/src/courses/dto/create-course.dto.ts b/backend/ayanavitabackend/app/api/src/courses/dto/create-course.dto.ts
index 1f1ca41d3472814e4d81a4a6ab42e34290473c50..2fcb2baff649f3ef7e45123d3589138b41c626fa 100644
--- a/backend/ayanavitabackend/app/api/src/courses/dto/create-course.dto.ts
+++ b/backend/ayanavitabackend/app/api/src/courses/dto/create-course.dto.ts
@@ -1,31 +1,108 @@
-import { IsBoolean, IsInt, IsOptional, IsString, Min } from 'class-validator';
+import {
+  IsArray,
+  IsBoolean,
+  IsInt,
+  IsNumber,
+  IsObject,
+  IsOptional,
+  IsString,
+  Max,
+  Min,
+  ValidateNested,
+} from 'class-validator'
+import { Type } from 'class-transformer'
+
+class I18nTextDto {
+  @IsOptional()
+  @IsString()
+  vi?: string
+
+  @IsOptional()
+  @IsString()
+  'en-US'?: string
+
+  @IsOptional()
+  @IsString()
+  de?: string
+}

 export class CreateCourseDto {
   @IsString()
-  title: string;
+  slug: string

+  @IsOptional()
   @IsString()
-  slug: string;
+  title?: string
+
+  @IsOptional()
+  @ValidateNested()
+  @Type(() => I18nTextDto)
+  titleI18n?: I18nTextDto

   @IsOptional()
   @IsString()
-  description?: string;
+  description?: string
+
+  @IsOptional()
+  @ValidateNested()
+  @Type(() => I18nTextDto)
+  descriptionI18n?: I18nTextDto
+
+  @IsOptional()
+  @ValidateNested()
+  @Type(() => I18nTextDto)
+  shortDescriptionI18n?: I18nTextDto

   @IsOptional()
   @IsString()
-  thumbnail?: string; // URL hoặc path
+  thumbnail?: string

   @IsOptional()
   @IsInt()
   @Min(0)
-  price?: number;
+  price?: number

   @IsOptional()
   @IsBoolean()
-  published?: boolean;
+  published?: boolean
+
   @IsOptional()
   @IsInt()
   @Min(1)
-  topicId?: number;
-}
+  topicId?: number

+  @IsOptional()
+  @IsArray()
+  @IsString({ each: true })
+  objectives?: string[]
+
+  @IsOptional()
+  @IsArray()
+  @IsString({ each: true })
+  targetAudience?: string[]
+
+  @IsOptional()
+  @IsArray()
+  @IsString({ each: true })
+  benefits?: string[]
+
+  @IsOptional()
+  @IsNumber()
+  @Min(0)
+  @Max(5)
+  ratingAvg?: number
+
+  @IsOptional()
+  @IsInt()
+  @Min(0)
+  ratingCount?: number
+
+  @IsOptional()
+  @IsInt()
+  @Min(0)
+  enrollmentCount?: number
+
+  @IsOptional()
+  @IsObject()
+  extraMeta?: Record<string, unknown>
+}
diff --git a/backend/ayanavitabackend/app/api/src/lessons/dto/create-lesson.dto.ts b/backend/ayanavitabackend/app/api/src/lessons/dto/create-lesson.dto.ts
index 5a7beb0ee17ac61b560ce5320796b8771d4b9543..b3d5773041100e699b162162c5994bc321d39053 100644
--- a/backend/ayanavitabackend/app/api/src/lessons/dto/create-lesson.dto.ts
+++ b/backend/ayanavitabackend/app/api/src/lessons/dto/create-lesson.dto.ts
@@ -1,26 +1,141 @@
-import { IsBoolean, IsInt, IsOptional, IsString, Min } from 'class-validator'
+import { Type } from 'class-transformer'
+import {
+  IsArray,
+  IsBoolean,
+  IsInt,
+  IsObject,
+  IsOptional,
+  IsString,
+  Min,
+  ValidateNested,
+} from 'class-validator'
+
+class I18nTextDto {
+  @IsOptional()
+  @IsString()
+  vi?: string
+
+  @IsOptional()
+  @IsString()
+  'en-US'?: string
+
+  @IsOptional()
+  @IsString()
+  de?: string
+}
+
+class LessonVideoDto {
+  @IsString()
+  title: string
+
+  @IsOptional()
+  @IsString()
+  description?: string
+
+  @IsOptional()
+  @ValidateNested()
+  @Type(() => I18nTextDto)
+  titleI18n?: I18nTextDto
+
+  @IsOptional()
+  @ValidateNested()
+  @Type(() => I18nTextDto)
+  descriptionI18n?: I18nTextDto
+
+  @IsOptional()
+  @IsString()
+  sourceUrl?: string
+
+  @IsOptional()
+  @IsInt()
+  @Min(0)
+  durationSec?: number
+
+  @IsOptional()
+  @IsInt()
+  @Min(0)
+  order?: number
+
+  @IsOptional()
+  @IsBoolean()
+  published?: boolean
+}
+
+class LessonModuleDto {
+  @IsString()
+  title: string
+
+  @IsOptional()
+  @IsString()
+  description?: string
+
+  @IsOptional()
+  @ValidateNested()
+  @Type(() => I18nTextDto)
+  titleI18n?: I18nTextDto
+
+  @IsOptional()
+  @ValidateNested()
+  @Type(() => I18nTextDto)
+  descriptionI18n?: I18nTextDto
+
+  @IsOptional()
+  @IsInt()
+  @Min(0)
+  order?: number
+
+  @IsOptional()
+  @IsBoolean()
+  published?: boolean
+
+  @IsOptional()
+  @IsArray()
+  @ValidateNested({ each: true })
+  @Type(() => LessonVideoDto)
+  videos?: LessonVideoDto[]
+}

 export class CreateLessonDto {
   @IsString()
   title!: string

   @IsString()
   slug!: string

+  @IsOptional()
+  @IsString()
+  description?: string
+
+  @IsOptional()
+  @ValidateNested()
+  @Type(() => I18nTextDto)
+  titleI18n?: I18nTextDto
+
+  @IsOptional()
+  @ValidateNested()
+  @Type(() => I18nTextDto)
+  descriptionI18n?: I18nTextDto
+
   @IsOptional()
   @IsString()
   content?: string

   @IsOptional()
   @IsString()
   videoUrl?: string

+  @IsOptional()
+  @IsArray()
+  @ValidateNested({ each: true })
+  @Type(() => LessonModuleDto)
+  modules?: LessonModuleDto[]
+
   @IsOptional()
   @IsInt()
   @Min(0)
   order?: number

   @IsOptional()
   @IsBoolean()
   published?: boolean
 }
diff --git a/backend/ayanavitabackend/app/api/src/lessons/dto/update-lesson.dto.ts b/backend/ayanavitabackend/app/api/src/lessons/dto/update-lesson.dto.ts
index 2d86e05a7b030a69f8557c348a7bcdeda638f280..2be64052a133896228f95eb455f21a756d51c430 100644
--- a/backend/ayanavitabackend/app/api/src/lessons/dto/update-lesson.dto.ts
+++ b/backend/ayanavitabackend/app/api/src/lessons/dto/update-lesson.dto.ts
@@ -1,28 +1,4 @@
-import { IsBoolean, IsInt, IsOptional, IsString, Min } from 'class-validator'
+import { PartialType } from '@nestjs/mapped-types'
+import { CreateLessonDto } from './create-lesson.dto'

-export class UpdateLessonDto {
-  @IsOptional()
-  @IsString()
-  title?: string
-
-  @IsOptional()
-  @IsString()
-  slug?: string
-
-  @IsOptional()
-  @IsString()
-  content?: string
-
-  @IsOptional()
-  @IsString()
-  videoUrl?: string
-
-  @IsOptional()
-  @IsInt()
-  @Min(0)
-  order?: number
-
-  @IsOptional()
-  @IsBoolean()
-  published?: boolean
-}
+export class UpdateLessonDto extends PartialType(CreateLessonDto) {}
diff --git a/backend/ayanavitabackend/app/api/src/lessons/lessons-media.service.ts b/backend/ayanavitabackend/app/api/src/lessons/lessons-media.service.ts
new file mode 100644
index 0000000000000000000000000000000000000000..3e035327bd276032fa93728d9925eed097a3f565
--- /dev/null
+++ b/backend/ayanavitabackend/app/api/src/lessons/lessons-media.service.ts
@@ -0,0 +1,143 @@
+import { Injectable, InternalServerErrorException } from '@nestjs/common'
+import { createHash, createHmac, randomUUID } from 'crypto'
+import { mkdir, readFile, rm, writeFile } from 'fs/promises'
+import { join } from 'path'
+import { tmpdir } from 'os'
+import { spawn } from 'child_process'
+
+@Injectable()
+export class LessonsMediaService {
+  private readonly s3Bucket = process.env.CLOUDFLY_BUCKET || 'ayanavita-dev'
+  private readonly s3Region = process.env.CLOUDFLY_REGION || 'auto'
+  private readonly s3Endpoint = process.env.CLOUDFLY_ENDPOINT || 'https://s3.cloudfly.vn'
+  private readonly s3AccessKey = process.env.CLOUDFLY_ACCESS_KEY || ''
+  private readonly s3SecretKey = process.env.CLOUDFLY_SECRET_KEY || ''
+
+  private hash(input: string | Buffer) {
+    return createHash('sha256').update(input).digest('hex')
+  }
+
+  private hmac(key: string | Buffer, msg: string) {
+    return createHmac('sha256', key).update(msg).digest()
+  }
+
+  private async uploadPrivateObject(key: string, body: Buffer, contentType: string) {
+    if (!this.s3AccessKey || !this.s3SecretKey) {
+      throw new InternalServerErrorException('Cloudfly credentials are not configured')
+    }
+
+    const now = new Date()
+    const amzDate = now.toISOString().replace(/[:-]|\.\d{3}/g, '')
+    const dateStamp = amzDate.slice(0, 8)
+    const host = new URL(this.s3Endpoint).host
+    const payloadHash = this.hash(body)
+
+    const headers = {
+      host,
+      'x-amz-content-sha256': payloadHash,
+      'x-amz-date': amzDate,
+      'x-amz-acl': 'private',
+      'content-type': contentType,
+    }
+
+    const signedHeaders = 'content-type;host;x-amz-acl;x-amz-content-sha256;x-amz-date'
+    const canonicalHeaders = Object.entries(headers)
+      .map(([k, v]) => `${k}:${String(v).trim()}\n`)
+      .join('')
+
+    const canonicalRequest = ['PUT', `/${this.s3Bucket}/${key}`, '', canonicalHeaders, signedHeaders, payloadHash].join('\n')
+    const credentialScope = `${dateStamp}/${this.s3Region}/s3/aws4_request`
+    const stringToSign = `AWS4-HMAC-SHA256\n${amzDate}\n${credentialScope}\n${this.hash(canonicalRequest)}`
+
+    const kDate = this.hmac(`AWS4${this.s3SecretKey}`, dateStamp)
+    const kRegion = this.hmac(kDate, this.s3Region)
+    const kService = this.hmac(kRegion, 's3')
+    const kSigning = this.hmac(kService, 'aws4_request')
+    const signature = createHmac('sha256', kSigning).update(stringToSign).digest('hex')
+
+    const authorization = `AWS4-HMAC-SHA256 Credential=${this.s3AccessKey}/${credentialScope}, SignedHeaders=${signedHeaders}, Signature=${signature}`
+    const uploadUrl = `${this.s3Endpoint.replace(/\/$/, '')}/${this.s3Bucket}/${key}`
+
+    const res = await fetch(uploadUrl, {
+      method: 'PUT',
+      headers: {
+        Authorization: authorization,
+        ...headers,
+      },
+      body: new Uint8Array(body),
+    })
+
+    if (!res.ok) {
+      const text = await res.text()
+      throw new InternalServerErrorException(`Upload video failed: ${res.status} ${text}`)
+    }
+
+    return key
+  }
+
+  private runFfmpeg(args: string[]) {
+    return new Promise<void>((resolve, reject) => {
+      const ffmpeg = spawn('ffmpeg', args)
+      let stderr = ''
+      ffmpeg.stderr.on('data', (chunk) => {
+        stderr += chunk.toString()
+      })
+      ffmpeg.on('close', (code) => {
+        if (code === 0) return resolve()
+        reject(new Error(stderr || `ffmpeg exited with ${code}`))
+      })
+    })
+  }
+
+  async transcodeToHlsAndUpload(file: { buffer: Buffer; originalname?: string }, lessonId: number, moduleId: string) {
+    const workDir = join(tmpdir(), `lms-hls-${randomUUID()}`)
+    await mkdir(workDir, { recursive: true })
+
+    const inputPath = join(workDir, file.originalname || 'input.mp4')
+    const outputPlaylist = join(workDir, 'index.m3u8')
+
+    try {
+      await writeFile(inputPath, file.buffer)
+      await this.runFfmpeg([
+        '-y',
+        '-i',
+        inputPath,
+        '-preset',
+        'veryfast',
+        '-g',
+        '48',
+        '-sc_threshold',
+        '0',
+        '-hls_time',
+        '6',
+        '-hls_playlist_type',
+        'vod',
+        '-hls_segment_filename',
+        join(workDir, 'segment_%03d.ts'),
+        outputPlaylist,
+      ])
+
+      const playlist = await readFile(outputPlaylist)
+      const playlistKey = `private/courses/${lessonId}/modules/${moduleId}/index.m3u8`
+      await this.uploadPrivateObject(playlistKey, playlist, 'application/vnd.apple.mpegurl')
+
+      const segmentPromises = Array.from({ length: 200 }).map(async (_, idx) => {
+        const name = `segment_${String(idx).padStart(3, '0')}.ts`
+        const path = join(workDir, name)
+        try {
+          const segment = await readFile(path)
+          const key = `private/courses/${lessonId}/modules/${moduleId}/${name}`
+          await this.uploadPrivateObject(key, segment, 'video/mp2t')
+          return key
+        } catch {
+          return null
+        }
+      })
+
+      const segmentKeys = (await Promise.all(segmentPromises)).filter(Boolean)
+      return { playlistKey, segmentKeys }
+    } finally {
+      await rm(workDir, { recursive: true, force: true })
+    }
+  }
+}
diff --git a/backend/ayanavitabackend/app/api/src/lessons/lessons.controller.ts b/backend/ayanavitabackend/app/api/src/lessons/lessons.controller.ts
index ef50bdfde9214a3d751868a48746945c6f23473a..deaeecb1588582e45cd2900354154843171d7e7b 100644
--- a/backend/ayanavitabackend/app/api/src/lessons/lessons.controller.ts
+++ b/backend/ayanavitabackend/app/api/src/lessons/lessons.controller.ts
@@ -1,64 +1,82 @@
 import {
   Body,
   Controller,
   Delete,
   Get,
   Param,
   ParseIntPipe,
   Patch,
   Post,
+  UploadedFile,
+  UseInterceptors,
   UseGuards,
 } from '@nestjs/common'
 import { LessonsService } from './lessons.service'
 import { CreateLessonDto } from './dto/create-lesson.dto'
 import { UpdateLessonDto } from './dto/update-lesson.dto'
 import { CurrentUser, JwtUser } from '../auth/decorators/current-user.decorator'
 import { AccessTokenGuard } from '../auth/guards/access-token.guard'
 import { RolesGuard } from '../auth/guards/roles.guard'
 import { Roles } from '../auth/decorators/roles.decorator'
+import { FileInterceptor } from '@nestjs/platform-express'
+import { memoryStorage } from 'multer'

 @UseGuards(AccessTokenGuard) // bắt buộc đăng nhập cho toàn controller
 @Controller()
 export class LessonsController {
   constructor(private readonly lessons: LessonsService) {}

   // USER/ADMIN: xem chi tiết lesson
   // Rule: USER chỉ xem được khi Enrollment ACTIVE; ADMIN bypass
   @Get('lessons/:id')
   findOne(
     @CurrentUser() user: JwtUser,
     @Param('id', ParseIntPipe) id: number,
   ) {
     return this.lessons.findOne(user, id)
   }

   // ADMIN: tạo lesson trong course
   @UseGuards(RolesGuard)
   @Roles('ADMIN')
   @Post('courses/:courseId/lessons')
   create(
     @Param('courseId', ParseIntPipe) courseId: number,
     @Body() dto: CreateLessonDto,
   ) {
     return this.lessons.create(courseId, dto)
   }

+
+  @UseGuards(RolesGuard)
+  @Roles('ADMIN')
+  @Post('lessons/:id/modules/:moduleId/videos/upload')
+  @UseInterceptors(FileInterceptor('file', { storage: memoryStorage() }))
+  uploadModuleVideo(
+    @Param('id', ParseIntPipe) lessonId: number,
+    @Param('moduleId') moduleId: string,
+    @UploadedFile() file?: any,
+  ) {
+    if (!file) return { message: 'Missing video file' }
+    return this.lessons.uploadModuleVideo(lessonId, moduleId, file)
+  }
+
   // ADMIN: update lesson
   @UseGuards(RolesGuard)
   @Roles('ADMIN')
   @Patch('lessons/:id')
   update(
     @Param('id', ParseIntPipe) id: number,
     @Body() dto: UpdateLessonDto,
   ) {
     return this.lessons.update(id, dto)
   }

   // ADMIN: delete lesson
   @UseGuards(RolesGuard)
   @Roles('ADMIN')
   @Delete('lessons/:id')
   remove(@Param('id', ParseIntPipe) id: number) {
     return this.lessons.remove(id)
   }
 }
diff --git a/backend/ayanavitabackend/app/api/src/lessons/lessons.module.ts b/backend/ayanavitabackend/app/api/src/lessons/lessons.module.ts
index 5e5716bc556d7d22709defb70e4825febd03b9ad..eb9a9c26f736098fdf833243cb5c87a94919766c 100644
--- a/backend/ayanavitabackend/app/api/src/lessons/lessons.module.ts
+++ b/backend/ayanavitabackend/app/api/src/lessons/lessons.module.ts
@@ -1,13 +1,14 @@
 import { Module } from '@nestjs/common'
 import { LessonsController } from './lessons.controller'
 import { LessonsService } from './lessons.service'
 import { PrismaModule } from '../prisma/prisma.module'
 import { EnrollmentsModule } from '../enrollments/enrollments.module'
+import { LessonsMediaService } from './lessons-media.service'


 @Module({
   imports: [PrismaModule, EnrollmentsModule],
   controllers: [LessonsController],
-  providers: [LessonsService],
+  providers: [LessonsService, LessonsMediaService],
 })
 export class LessonsModule {}
diff --git a/backend/ayanavitabackend/app/api/src/lessons/lessons.service.ts b/backend/ayanavitabackend/app/api/src/lessons/lessons.service.ts
index 985136e456ea0cf01f1d275fc570f28d3ea5c9a5..addf16d317fe52ae31d7b1958d37cbb6bba43778 100644
--- a/backend/ayanavitabackend/app/api/src/lessons/lessons.service.ts
+++ b/backend/ayanavitabackend/app/api/src/lessons/lessons.service.ts
@@ -1,93 +1,226 @@
 import { ForbiddenException, Injectable, NotFoundException } from '@nestjs/common'
 import { PrismaService } from '../prisma/prisma.service'
 import { CreateLessonDto } from './dto/create-lesson.dto'
 import { UpdateLessonDto } from './dto/update-lesson.dto'
 import { EnrollmentsService } from '../enrollments/enrollments.service'
+import { LessonsMediaService } from './lessons-media.service'
 import { JwtUser } from '../auth/decorators/current-user.decorator'
 import { ProgressStatus } from '@prisma/client'

 @Injectable()
 export class LessonsService {
   constructor(
     private readonly prisma: PrismaService,
     private readonly enrollments: EnrollmentsService,
+    private readonly media: LessonsMediaService,
   ) {}

-  // GET /lessons/:id  -> trả content (GATED)
   async findOne(user: JwtUser, id: number) {
     const lesson = await this.prisma.lesson.findUnique({
       where: { id },
       select: {
         id: true,
         courseId: true,
         title: true,
         slug: true,
+        description: true,
+        titleI18n: true,
+        descriptionI18n: true,
         order: true,
         published: true,
-        content: true, // content bị gate ở đây
-        videoUrl: true, // thêm nếu schema có field này
+        content: true,
+        videoUrl: true,
         createdAt: true,
         updatedAt: true,
+        modules: {
+          where: user.role === 'ADMIN' ? {} : { published: true },
+          orderBy: [{ order: 'asc' }, { id: 'asc' }],
+          select: {
+            id: true,
+            title: true,
+            description: true,
+            titleI18n: true,
+            descriptionI18n: true,
+            order: true,
+            published: true,
+            videos: {
+              where: user.role === 'ADMIN' ? {} : { published: true },
+              orderBy: [{ order: 'asc' }, { id: 'asc' }],
+              select: {
+                id: true,
+                title: true,
+                description: true,
+                titleI18n: true,
+                descriptionI18n: true,
+                sourceUrl: true,
+                hlsPlaylistKey: true,
+                durationSec: true,
+                order: true,
+                published: true,
+              },
+            },
+          },
+        },
       },
     })
     if (!lesson) throw new NotFoundException('Lesson not found')

-    // Gate 1: phải enroll course của lesson (ADMIN bypass)
     await this.enrollments.assertEnrolledOrAdmin(user, lesson.courseId)

-    // Gate 2: USER không xem lesson unpublished (ẩn bằng 404)
     if (user.role !== 'ADMIN' && !lesson.published) {
       throw new NotFoundException('Lesson not found')
     }

-    // Gate 3: Sequential unlock (USER phải hoàn thành lesson trước)
-    // ADMIN bypass
     if (user.role !== 'ADMIN') {
-      // Lesson trước đó trong cùng course (published)
-      // Tie-break bằng (order, id) để xử lý trường hợp order trùng nhau
       const prev = await this.prisma.lesson.findFirst({
         where: {
           courseId: lesson.courseId,
           published: true,
-          OR: [
-            { order: { lt: lesson.order ?? 0 } },
-            { order: lesson.order ?? 0, id: { lt: lesson.id } },
-          ],
+          OR: [{ order: { lt: lesson.order ?? 0 } }, { order: lesson.order ?? 0, id: { lt: lesson.id } }],
         },
         select: { id: true },
         orderBy: [{ order: 'desc' }, { id: 'desc' }],
       })

-      // Nếu có lesson trước => phải COMPLETED mới cho xem lesson hiện tại
       if (prev) {
         const prevProgress = await this.prisma.lessonProgress.findUnique({
           where: { userId_lessonId: { userId: user.sub, lessonId: prev.id } },
           select: { status: true },
         })
-
         if (!prevProgress || prevProgress.status !== ProgressStatus.COMPLETED) {
           throw new ForbiddenException('Complete previous lesson first')
         }
       }
     }

     return lesson
   }

-  // ADMIN: create lesson
-  create(courseId: number, dto: CreateLessonDto) {
-    return this.prisma.lesson.create({
-      data: { ...dto, courseId },
+  async create(courseId: number, dto: CreateLessonDto) {
+    return this.prisma.$transaction(async (tx) => {
+      const lesson = await tx.lesson.create({
+        data: {
+          courseId,
+          title: dto.title,
+          slug: dto.slug,
+          description: dto.description,
+          titleI18n: dto.titleI18n as any,
+          descriptionI18n: dto.descriptionI18n as any,
+          content: dto.content,
+          videoUrl: dto.videoUrl,
+          order: dto.order,
+          published: dto.published,
+        } as any,
+      })
+
+      if (dto.modules?.length) {
+        for (const m of dto.modules) {
+          const mod = await tx.lessonModule.create({
+            data: {
+              lessonId: lesson.id,
+              title: m.title,
+              description: m.description,
+              titleI18n: m.titleI18n as any,
+              descriptionI18n: m.descriptionI18n as any,
+              order: m.order,
+              published: m.published,
+            } as any,
+          })
+
+          if (m.videos?.length) {
+            await tx.lessonVideo.createMany({
+              data: m.videos.map((v, idx) => ({
+                moduleId: mod.id,
+                title: v.title,
+                description: v.description,
+                titleI18n: v.titleI18n as any,
+                descriptionI18n: v.descriptionI18n as any,
+                sourceUrl: v.sourceUrl,
+                durationSec: v.durationSec ?? 0,
+                order: v.order ?? idx,
+                published: v.published ?? true,
+              })) as any,
+            })
+          }
+        }
+      }
+
+      return lesson
     })
   }

-  // ADMIN: update lesson
-  update(id: number, dto: UpdateLessonDto) {
-    return this.prisma.lesson.update({ where: { id }, data: dto })
+  async uploadModuleVideo(lessonId: number, moduleId: string, file: { buffer: Buffer; originalname?: string }) {
+    const lesson = await this.prisma.lesson.findUnique({ where: { id: lessonId }, select: { id: true } })
+    if (!lesson) throw new NotFoundException('Lesson not found')
+
+    const upload = await this.media.transcodeToHlsAndUpload(file, lessonId, moduleId)
+
+    return {
+      moduleId,
+      lessonId,
+      hlsPlaylistKey: upload.playlistKey,
+      segmentCount: upload.segmentKeys.length,
+      storage: 'private-bucket',
+    }
+  }
+
+  async update(id: number, dto: UpdateLessonDto) {
+    return this.prisma.$transaction(async (tx) => {
+      const lesson = await tx.lesson.update({
+        where: { id },
+        data: {
+          title: dto.title,
+          slug: dto.slug,
+          description: dto.description,
+          titleI18n: dto.titleI18n as any,
+          descriptionI18n: dto.descriptionI18n as any,
+          content: dto.content,
+          videoUrl: dto.videoUrl,
+          order: dto.order,
+          published: dto.published,
+        } as any,
+      })
+
+      if (dto.modules) {
+        await tx.lessonVideo.deleteMany({ where: { module: { lessonId: id } } as any })
+        await tx.lessonModule.deleteMany({ where: { lessonId: id } })
+
+        for (const m of dto.modules) {
+          const mod = await tx.lessonModule.create({
+            data: {
+              lessonId: id,
+              title: m.title,
+              description: m.description,
+              titleI18n: m.titleI18n as any,
+              descriptionI18n: m.descriptionI18n as any,
+              order: m.order,
+              published: m.published,
+            } as any,
+          })
+
+          if (m.videos?.length) {
+            await tx.lessonVideo.createMany({
+              data: m.videos.map((v, idx) => ({
+                moduleId: mod.id,
+                title: v.title,
+                description: v.description,
+                titleI18n: v.titleI18n as any,
+                descriptionI18n: v.descriptionI18n as any,
+                sourceUrl: v.sourceUrl,
+                durationSec: v.durationSec ?? 0,
+                order: v.order ?? idx,
+                published: v.published ?? true,
+              })) as any,
+            })
+          }
+        }
+      }
+
+      return lesson
+    })
   }

-  // ADMIN: delete lesson
   remove(id: number) {
     return this.prisma.lesson.delete({ where: { id } })
=======
diff --git a/Home/ayanavita-fontend-final/src/App.tsx b/Home/ayanavita-fontend-final/src/App.tsx
index ec0414b697beac79b80e2be8f84c8b11fc5ffafb..3ac96cbb997fddd2695c68b639f0dd5868d89c94 100644
--- a/Home/ayanavita-fontend-final/src/App.tsx
+++ b/Home/ayanavita-fontend-final/src/App.tsx
@@ -14,44 +14,44 @@ import HomePage from "./pages/HomePage";
 import LessonDetailPage from "./pages/LessonDetailPage";
 import ProductCheckoutPage from "./pages/ProductCheckoutPage";
 import ProductDetailPage from "./pages/ProductDetailPage";

 import ProductsPage from "./pages/ProductsPage";
 import ReviewsCenterPage from "./pages/ReviewsCenterPage";
 import ServiceDetailPage from "./pages/ServiceDetailPage";
 import ServicesPage from "./pages/ServicesPage";
 import TrackOrderPage from "./pages/TrackOrderPage";

 export default function App() {
   return (
     <Routes>
       <Route element={<Layout />}>
         <Route path="/" element={<HomePage />} />
         <Route path="/services" element={<ServicesPage />} />
         <Route path="/services/:serviceId" element={<ServiceDetailPage />} />
         <Route path="/booking" element={<BookingPage />} />

         <Route path="/courses" element={<CoursesPage />} />
         <Route path="/courses/:courseId" element={<CourseDetailPage />} />
         <Route path="/courses/:courseId/lesson" element={<LessonDetailPage />} />
         <Route path="/courses/player" element={<CoursePlayerPage />} />

         <Route path="/products" element={<ProductsPage />} />
-        <Route path="/products/:sku" element={<ProductDetailPage />} />
+        <Route path="/products/:slug" element={<ProductDetailPage />} />
         <Route path="/cart" element={<CartPage />} />
         <Route path="/product-checkout" element={<ProductCheckoutPage />} />
         <Route path="/checkout" element={<CheckoutPage />} />
         <Route path="/compare" element={<ComparePage />} />
         <Route path="/track-order" element={<TrackOrderPage />} />

         <Route path="/reviews" element={<ReviewsCenterPage />} />
         <Route path="/blog" element={<BlogPage />} />
         <Route path="/contact" element={<ContactPage />} />


         <Route path="/franchise" element={<div className="p-6">Franchise (todo)</div>} />
         <Route path="/account" element={<div className="p-6">Account (todo)</div>} />
         <Route path="*" element={<div className="p-6">Not found</div>} />
       </Route>
     </Routes>
   );
 }
diff --git a/Home/ayanavita-fontend-final/src/pages/ProductDetailPage.tsx b/Home/ayanavita-fontend-final/src/pages/ProductDetailPage.tsx
index 846f6fa15fdb1799b2cb22e7a86594f0db6b37db..37eeed5d3c95d72fc9ebc8d5597fe3edfa8f30ef 100644
--- a/Home/ayanavita-fontend-final/src/pages/ProductDetailPage.tsx
+++ b/Home/ayanavita-fontend-final/src/pages/ProductDetailPage.tsx
@@ -131,51 +131,51 @@ const defaultCmsData = {
       items: [
         "Giá niêm yết rõ ràng",
         "Hỗ trợ tư vấn routine",
         "Review minh bạch (demo)"
       ],
       bulletIcon: "•"
     }
   },
   ingredients: {
     sectionTitle: "Thành phần",
     title: "Thành phần nổi bật (demo)",
     description: "Bạn thay bằng thành phần thật theo sản phẩm trong DB.",
     chip: { text: "INCI (mô phỏng)", icon: "fa-solid fa-flask", iconColor: "text-indigo-600" },
     noteTitle: "Lưu ý",
     noteText: "Prototype: không đưa claim y khoa. Khi làm thật nên có cảnh báo dị ứng/patch test và hướng dẫn theo chuyên gia."
   },
   usage: {
     sectionTitle: "Cách dùng",
     title: "Routine gợi ý",
     morning: { title: "Buổi sáng", icon: "fa-solid fa-sun", iconColor: "text-amber-600" },
     evening: { title: "Buổi tối", icon: "fa-solid fa-moon", iconColor: "text-indigo-600" },
     checklistTitle: "Checklist nhanh"
   },
   combo: {
     sectionTitle: "Combo đề xuất",
-    title: "Mua cùng",
+    title: "Sản phẩm cùng danh mục",
     disclaimer: "Prototype: sản phẩm liên quan lấy từ dữ liệu demo."
   },
   reviews: {
     sectionTitle: "Đánh giá",
     summaryTitle: "Tổng quan review",
     filterTitle: "Bộ lọc",
     sortOptions: [
       { value: "new", text: "Mới nhất" },
       { value: "high", text: "Sao cao" },
       { value: "low", text: "Sao thấp" }
     ],
     starFilterOptions: [
       { value: "all", text: "Tất cả sao" },
       { value: "5", text: "5 sao" },
       { value: "4", text: "4 sao" },
       { value: "3", text: "3 sao" },
       { value: "2", text: "2 sao" },
       { value: "1", text: "1 sao" }
     ],
     writeReviewButton: { text: "Viết đánh giá", icon: "fa-solid fa-pen-to-square" },
     listTitle: "Review",
     listSubtitle: "Khách hàng nói gì?",
     disclaimer: "Prototype: review lưu localStorage, bạn có thể nối backend.",
     searchPlaceholder: "Tìm trong review...",
     noReviewsText: "Không có review phù hợp bộ lọc."
@@ -193,129 +193,129 @@ const defaultCmsData = {
         answer: "Thường 7–14 ngày (demo). Khi làm thật mô tả theo khuyến nghị thực tế."
       },
       {
         question: "Giá niêm yết có thay đổi không?",
         answer: "Giá có thể cập nhật theo thời điểm. Khi làm thật, lưu lịch sử giá/khuyến mãi."
       }
     ]
   }
 };

 // ==================== UTILS ====================
 function copyToClipboard(text: string) {
   if (!text) return;
   const nav: any = navigator;
   if (nav.clipboard?.writeText) return nav.clipboard.writeText(text);
   const ta = document.createElement("textarea");
   ta.value = text;
   document.body.appendChild(ta);
   ta.select();
   document.execCommand("copy");
   document.body.removeChild(ta);
 }

 // ==================== COMPONENT ====================
 export default function ProductDetailPage() {
-  const { sku: skuParam } = useParams<{ sku: string }>();
+  const { slug: slugParam } = useParams<{ slug: string }>();
   const navigate = useNavigate();

   // ===== NGÔN NGỮ & CMS DYNAMIC =====
   const [currentLanguage, setCurrentLanguage] = useState<string>(() => {
     return localStorage.getItem("preferred-language") || "vi";
   });

   const [detailData, setDetailData] = useState<any>(null);
   const [cmsData, setCmsData] = useState(defaultCmsData);
   const [apiProduct, setApiProduct] = useState<any>(null);
   const [loadingProduct, setLoadingProduct] = useState(false);
   const [productError, setProductError] = useState<string | null>(null);

   // Lắng nghe sự kiện thay đổi ngôn ngữ
   useEffect(() => {
     const handleLanguageChange = (event: CustomEvent) => {
       setCurrentLanguage(event.detail.language);
     };

     window.addEventListener('languageChange', handleLanguageChange as EventListener);
     return () => {
       window.removeEventListener('languageChange', handleLanguageChange as EventListener);
     };
   }, []);

   // Gọi API khi ngôn ngữ thay đổi
   useEffect(() => {
     const fetchData = async () => {
       try {
         const res = await http.get(`/public/pages/productDetail?lang=${currentLanguage}`);
         setDetailData(res.data);
         console.log("Product Detail CMS data:", res.data);
         // Ghi đè cmsData bằng dữ liệu từ sections[2] nếu có
         if (res.data?.sections?.[2]?.data) {
           console.log("Overriding CMS data with API data from sections[2].data", res.data.sections[2].data);
           setCmsData(res.data.sections[2].data);
           setTimeout(() => {console.log("Sau khi đợi 2s",cmsData)}, 2000)

         }
       } catch (error) {
         console.error("Failed to fetch CMS data:", error);
         // Giữ nguyên cmsData mặc định
       }
     };
     fetchData();
   }, [currentLanguage]);

   useEffect(() => {
-    if (!skuParam) return;
+    if (!slugParam) return;

     let cancelled = false;
     const fetchProductDetail = async () => {
       setLoadingProduct(true);
       setProductError(null);
       try {
-        const res = await http.get(`/public/catalog/products/${skuParam}?lang=${currentLanguage}`);
+        const res = await http.get(`/public/catalog/products/slug/${slugParam}?lang=${currentLanguage}`);
         if (!cancelled) {
           setApiProduct(res.data);
         }
-        console.log(`GET /public/catalog/products/${skuParam} response:`, res.data);
+        console.log(`GET /public/catalog/products/slug/${slugParam} response:`, res.data);
       } catch (error) {
-        console.error('GET /public/catalog/products/:sku failed:', error);
+        console.error('GET /public/catalog/products/slug/:slug failed:', error);
         if (!cancelled) {
           setApiProduct(null);
           setProductError("Không tải được dữ liệu sản phẩm từ API.");
         }
       } finally {
         if (!cancelled) setLoadingProduct(false);
       }
     };

     fetchProductDetail();
     return () => {
       cancelled = true;
     };
-  }, [skuParam, currentLanguage]);
+  }, [slugParam, currentLanguage]);

-  const productKey = useMemo(() => String(apiProduct?.sku || skuParam || ""), [apiProduct?.sku, skuParam]);
+  const productKey = useMemo(() => String(apiProduct?.sku || slugParam || ""), [apiProduct?.sku, slugParam]);

   const images = useMemo(() => {
     const rows = Array.isArray(apiProduct?.images) ? apiProduct.images.slice() : [];
     // Ưu tiên sortOrder tăng dần, rồi ưu tiên isPrimary
     rows.sort((a: any, b: any) => {
       const ao = Number.isFinite(Number(a?.sortOrder)) ? Number(a.sortOrder) : 999999;
       const bo = Number.isFinite(Number(b?.sortOrder)) ? Number(b.sortOrder) : 999999;
       if (ao !== bo) return ao - bo;
       if (!!a?.isPrimary !== !!b?.isPrimary) return a?.isPrimary ? -1 : 1;
       return 0;
     });
     const urls = rows.map((x: any) => x?.imageUrl).filter(Boolean);
     if (urls.length) {
       const primary = rows.find((x: any) => x?.isPrimary && x?.imageUrl)?.imageUrl;
       if (primary) return [primary, ...urls.filter((u: string) => u !== primary)];
       return urls;
     }
     return apiProduct?.image ? [apiProduct.image] : [];
   }, [apiProduct]);

   const [mainImg, setMainImg] = useState(images[0]);
   useEffect(() => {
     setMainImg(images[0]);
     window.scrollTo({ top: 0, behavior: "smooth" });
   }, [productKey, images]);
@@ -369,57 +369,57 @@ export default function ProductDetailPage() {
   const shortDesc = apiProduct?.shortDescription || "";
   const longDesc = apiProduct?.description || "";

   const ingredients = useMemo(() => {
     return Array.isArray(apiProduct?.ingredients)
         ? apiProduct.ingredients
             .map((x: any) => ({ name: x?.name, desc: x?.value || x?.note || "" }))
             .filter((x: any) => x?.name)
         : [];
   }, [apiProduct?.ingredients]);

   const formatAttributeValue = (a: any) => {
     if (a?.valueText != null && String(a.valueText).trim() !== "") return String(a.valueText);
     if (a?.valueNumber != null && a.valueNumber !== "") return String(a.valueNumber);
     if (a?.valueBoolean != null) return a.valueBoolean ? "Có" : "Không";
     if (a?.valueJson != null) {
       try {
         return typeof a.valueJson === "string" ? a.valueJson : JSON.stringify(a.valueJson);
       } catch {
         return "[json]";
       }
     }
     return "—";
   };

-  if (!skuParam) {
+  if (!slugParam) {
     return (
         <div className="text-slate-900">
           <main className="px-4 pb-10">
             <div className="max-w-4xl mx-auto card p-6">
               <div className="text-2xl font-extrabold">Thiếu mã sản phẩm</div>
-              <div className="mt-2 text-slate-600">URL không có tham số SKU.</div>
+              <div className="mt-2 text-slate-600">URL không có tham số slug sản phẩm.</div>
               <Link className="mt-4 btn btn-primary inline-block" to="/products">Về danh mục</Link>
             </div>
           </main>
         </div>
     );
   }

   if (loadingProduct) {
     return (
         <div className="text-slate-900">
           <main className="px-4 pb-10">
             <div className="max-w-7xl mx-auto">
               <div className="card p-6">
                 <div className="text-2xl font-extrabold">Đang tải sản phẩm…</div>
                 <div className="mt-2 text-slate-600">Vui lòng đợi một chút.</div>
               </div>
             </div>
           </main>
         </div>
     );
   }

   if (productError || !apiProduct) {
     return (
         <div className="text-slate-900">
@@ -754,65 +754,65 @@ export default function ProductDetailPage() {
         {/* USAGE */}
         <section id="usage" className="mx-auto max-w-7xl px-4 pb-10">
           <div className="grid gap-5 lg:grid-cols-3">
             <div className="card p-6 lg:col-span-2">
               <div className="text-xs font-extrabold text-slate-500">{cmsData.usage.sectionTitle}</div>
               <div className="text-2xl font-extrabold">{cmsData.usage.title}</div>
               <p>{guideIntro || "—"}</p>
               <div className="mt-4">
                 <div className="rounded-2xl bg-slate-50 p-5 ring-1 ring-slate-200">
                   <ol className="mt-3 grid gap-2 text-sm text-slate-700">
                     {guideSteps.length ? guideSteps.map((s: any, idx: number) => (
                         <li key={`${s?.order || idx}`} className="flex gap-2">
                           <span className="font-extrabold text-amber-600">{idx + 1}. </span>
                           {s?.content || "—"}
                         </li>
                     )) : (
                         <li className="text-slate-600">Chưa có các bước hướng dẫn.</li>
                     )}

                   </ol>
                 </div>
               </div>

             </div>

-            {/* Combo đề xuất: chỉ hiển thị khi backend có dữ liệu liên quan */}
+            {/* Sản phẩm cùng danh mục: chỉ hiển thị khi backend có dữ liệu liên quan */}
             {Array.isArray(apiProduct?.relatedProducts) && apiProduct.relatedProducts.length ? (
                 <div className="card p-6">
                   <div className="text-xs font-extrabold text-slate-500">{cmsData.combo.sectionTitle}</div>
                   <div className="text-2xl font-extrabold">{cmsData.combo.title}</div>

                   <div className="mt-4 grid gap-3">
-                    {apiProduct.relatedProducts.map((p: any) => (
+                    {apiProduct.relatedProducts.slice(0, 5).map((p: any) => (
                         <div key={p?.sku || p?.id} className="rounded-2xl bg-slate-50 p-4 ring-1 ring-slate-200">
                           <div className="flex gap-3">
                             <img className="h-16 w-16 rounded-2xl object-cover border border-slate-200" src={p?.image || p?.img || images?.[0]} alt={p?.name || ""} />
                             <div className="min-w-0">
                               <div className="font-extrabold truncate">{p?.name}</div>
                               <div className="text-sm text-slate-500">{money(Number(p?.price || 0))}</div>
-                              <button className="btn mt-2 w-full" type="button" onClick={() => navigate(`/products/${p?.sku || p?.id}`)}>
+                              <button className="btn mt-2 w-full" type="button" onClick={() => navigate(`/products/${p?.slug || p?.sku || p?.id}`)}>
                                 <i className="fa-solid fa-arrow-right mr-2" />Xem
                               </button>
                             </div>
                           </div>
                         </div>
                     ))}
                   </div>

                   <div className="mt-4 text-xs text-slate-500">{cmsData.combo.disclaimer}</div>
                 </div>
             ) : null}
           </div>
         </section>

         {/* REVIEWS */}
         <section id="reviews" className="mx-auto max-w-7xl px-4 pb-10">
           <div className="grid gap-5 lg:grid-cols-3">
             <div className="card p-6">
               <div className="text-xs font-extrabold text-slate-500">{cmsData.reviews.sectionTitle}</div>
               <div className="text-2xl font-extrabold">{cmsData.reviews.summaryTitle}</div>

               <div className="mt-4 rounded-2xl bg-slate-50 p-5 ring-1 ring-slate-200">
                 <div className="text-5xl font-extrabold">{effectiveAvg ? effectiveAvg.toFixed(1) : "—"}</div>
                 <div className="mt-2 text-xl"><Stars value={effectiveAvg} /></div>
                 <div className="mt-1 text-sm text-slate-500">{effectiveCount} {cmsData.purchaseBox.reviewText} • (demo)</div>
diff --git a/Home/ayanavita-fontend-final/src/pages/ProductsPage.tsx b/Home/ayanavita-fontend-final/src/pages/ProductsPage.tsx
index 057571275eef1f7332637219ce694c283dc5f284..ce6a6a62a7406d6f1579ef9664569c1a37f9b941 100644
--- a/Home/ayanavita-fontend-final/src/pages/ProductsPage.tsx
+++ b/Home/ayanavita-fontend-final/src/pages/ProductsPage.tsx
@@ -365,51 +365,51 @@ export default function ProductsPage() {
               </div>
             </aside>

             <section className="lg:col-span-3">
               <div className="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
                 <div className="flex items-center gap-2 flex-wrap">
                   {(cmsData?.badges || []).map((b: any) => (
                     <span key={`${b.icon}-${b.text}`} className="chip">
                       <i className={b.icon} />
                       <span className="ml-2">{b.text}</span>
                     </span>
                   ))}
                 </div>
                 <div className="text-sm text-slate-600">
                   {cmsData?.results?.label}: <b>{apiTotal}</b> {cmsData?.results?.unit}
                 </div>
               </div>

               <div className="mt-4 grid gap-3 sm:grid-cols-2 lg:grid-cols-3">
                 {pageItems.length ? (
                   pageItems.map((p) => (
                     <ProductCard
                       cmsData={productData?.sections?.[1]?.data}
                       key={p.id}
                       p={p}
-                      detailTo={`/products/${String(p.sku)}`}
+                      detailTo={`/products/${String((p as any).slug || p.sku)}`}
                       onCompare={handleCompareProduct}
                     />
                   ))
                 ) : (
                   <div className="text-slate-600 p-6">{cmsData?.emptyState}</div>
                 )}
               </div>

               <PaginationBar
                 cmsData={cmsData}
                 page={safePage}
                 totalPages={totalPages}
                 onPrev={() => setPage((p) => Math.max(1, p - 1))}
                 onNext={() => setPage((p) => Math.min(totalPages, p + 1))}
               />
             </section>
           </div>
         </div>

         <div className="max-w-6xl mx-auto mt-4 text-center text-sm text-slate-500">{cmsData?.footer}</div>
       </main>

       {compareToast.open ? (
         <div className="fixed bottom-4 right-4 z-[90] w-[min(420px,calc(100vw-32px))] rounded-2xl border border-white/10 bg-slate-900 p-3 text-white shadow-2xl">
           <div className="flex items-start justify-between gap-3">
diff --git a/backend/ayanavitabackend/app/api/src/catalog/public-catalog.controller.ts b/backend/ayanavitabackend/app/api/src/catalog/public-catalog.controller.ts
index ebd49346c86df40081210422e0c1849c0fc22922..705fe07f930a0564fac051070bc617d768ac4ef4 100644
--- a/backend/ayanavitabackend/app/api/src/catalog/public-catalog.controller.ts
+++ b/backend/ayanavitabackend/app/api/src/catalog/public-catalog.controller.ts
@@ -1,18 +1,23 @@
 import { Controller, Get, Param, Query } from '@nestjs/common'
 import { PublicCatalogService } from './public-catalog.service'
 import { PublicCatalogQueryDto } from './dto/public-catalog-query.dto'

 @Controller('public/catalog')
 export class PublicCatalogController {
   constructor(private readonly service: PublicCatalogService) {}

   @Get('products')
   list(@Query() query: PublicCatalogQueryDto) {
     return this.service.list(query, query.lang ?? 'vi')
   }

   @Get('products/:sku')
   detail(@Param('sku') sku: string, @Query('lang') lang = 'vi') {
     return this.service.detailBySku(sku, lang)
   }
+
+  @Get('products/slug/:slug')
+  detailBySlug(@Param('slug') slug: string, @Query('lang') lang = 'vi') {
+    return this.service.detailBySlug(slug, lang)
+  }
 }
diff --git a/backend/ayanavitabackend/app/api/src/catalog/public-catalog.service.ts b/backend/ayanavitabackend/app/api/src/catalog/public-catalog.service.ts
index c29cbb72b016cef1e62da985553d7493ce3366bf..4154a1a8b7a5385867fd13092ae440396609438f 100644
--- a/backend/ayanavitabackend/app/api/src/catalog/public-catalog.service.ts
+++ b/backend/ayanavitabackend/app/api/src/catalog/public-catalog.service.ts
@@ -139,68 +139,129 @@ export class PublicCatalogService {
         skip,
         take: pageSize,
       }),
       this.prisma.catalogProduct.count({ where }),
     ])

     const items = rows.map((item) => this.mapProduct(item, lang))

     if (query.sort === 'nameAsc') {
       items.sort((a, b) => String(a.name).localeCompare(String(b.name), lang))
     }

     if (query.sort === 'nameDesc') {
       items.sort((a, b) => String(b.name).localeCompare(String(a.name), lang))
     }

     return normalizeBigInt({
       items,
       page,
       pageSize,
       total,
       totalPages: Math.max(1, Math.ceil(total / pageSize)),
     })
   }

-  async detailBySku(sku: string, lang = 'vi') {
-    const row = await this.prisma.catalogProduct.findFirst({
+  private getDetailInclude(lang: string): Prisma.CatalogProductInclude {
+    return {
+      translations: { where: { languageCode: lang }, take: 1 },
+      category: {
+        include: {
+          translations: { where: { languageCode: lang }, take: 1 },
+        },
+      },
+      images: { orderBy: [{ isPrimary: 'desc' }, { sortOrder: 'asc' }, { id: 'asc' }] },
+      attributes: {
+        include: {
+          attributeKey: {
+            include: {
+              translations: { where: { languageCode: lang }, take: 1 },
+            },
+          },
+        },
+      },
+      ingredients: {
+        include: {
+          ingredientKey: {
+            include: {
+              translations: { where: { languageCode: lang }, take: 1 },
+            },
+          },
+        },
+        orderBy: { sortOrder: 'asc' },
+      },
+    }
+  }
+
+  private async buildDetailResponse(row: any, lang: string) {
+    const mapped = this.mapProduct(row, lang)
+
+    const relatedRows = await this.prisma.catalogProduct.findMany({
       where: {
-        sku,
         status: 'active',
+        categoryId: row.categoryId,
+        id: { not: row.id },
         translations: {
           some: { languageCode: lang },
         },
       },
       include: {
         translations: { where: { languageCode: lang }, take: 1 },
-        category: {
-          include: {
-            translations: { where: { languageCode: lang }, take: 1 },
-          },
-        },
         images: { orderBy: [{ isPrimary: 'desc' }, { sortOrder: 'asc' }, { id: 'asc' }] },
-        attributes: {
-          include: {
-            attributeKey: {
-              include: {
-                translations: { where: { languageCode: lang }, take: 1 },
-              },
-            },
-          },
+      },
+      orderBy: [{ createdAt: 'desc' }, { id: 'desc' }],
+      take: 5,
+    })
+
+    const relatedProducts = relatedRows.map((item) => {
+      const translation = item.translations[0] ?? null
+      const primaryImage = item.images?.[0] ?? null
+      return {
+        id: item.id,
+        sku: item.sku,
+        slug: translation?.slug ?? item.sku,
+        name: translation?.name ?? item.sku,
+        price: item.price,
+        image: primaryImage?.imageUrl ?? null,
+      }
+    })
+
+    return normalizeBigInt({
+      ...mapped,
+      relatedProducts,
+    })
+  }
+
+  async detailBySku(sku: string, lang = 'vi') {
+    const row = await this.prisma.catalogProduct.findFirst({
+      where: {
+        sku,
+        status: 'active',
+        translations: {
+          some: { languageCode: lang },
         },
-        ingredients: {
-          include: {
-            ingredientKey: {
-              include: {
-                translations: { where: { languageCode: lang }, take: 1 },
-              },
-            },
+      },
+      include: this.getDetailInclude(lang),
+    })
+
+    if (!row) throw new NotFoundException('Product not found')
+    return this.buildDetailResponse(row, lang)
+  }
+
+  async detailBySlug(slug: string, lang = 'vi') {
+    const row = await this.prisma.catalogProduct.findFirst({
+      where: {
+        status: 'active',
+        translations: {
+          some: {
+            languageCode: lang,
+            slug,
           },
-          orderBy: { sortOrder: 'asc' },
         },
       },
+      include: this.getDetailInclude(lang),
     })

     if (!row) throw new NotFoundException('Product not found')
-    return normalizeBigInt(this.mapProduct(row, lang))
+    return this.buildDetailResponse(row, lang)
>>>>>>> 4b948bf2ec400ab59f778729e8a1a257d3282303
   }
 }
